<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Matt Strimas-Mackey, Tom Auer, Daniel Fink" />

<meta name="date" content="2019-04-02" />

<title>Generating Seasonal Abundance and Range Maps and Stats</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' || rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Generating Seasonal Abundance and Range Maps and Stats</h1>
<h4 class="author">Matt Strimas-Mackey, Tom Auer, Daniel Fink</h4>
<h4 class="date">2019-04-02</h4>



<div id="outline" class="section level1">
<h1>Outline</h1>
<ol style="list-style-type: decimal">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#data-download">Data Download</a></li>
<li><a href="#seasonal-abundance">Seasonal Abundance</a></li>
<li><a href="#abundance-maps">Abundance Maps</a></li>
<li><a href="#range-maps">Range Maps</a></li>
<li><a href="#regional-statistics">Regional Statistics</a></li>
</ol>
</div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This vignette describes how to recreate the seasonal map products found on the <a href="https://ebird.org/science/status-and-trends">eBird Status and Trends pages</a>. First, the vignette will cover how to average the abundance data seasonally, then it will proceed with examples of making abundance maps, aggregating and smoothing data for range maps, and, finally, provide examples of calculating regional summary statistic. Throughout this vignette we will use the simplified example dataset available through the <code>ebirdst_download()</code> function, which consists of the Yellow-bellied Sapsucker data spatially subset to the state of Michigan. However, these methods can be applied to the full datasets for any of the eBird Status and Trends species.</p>
<p>Let’s begin by loading all the packages we’ll need for this vignette.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(ebirdst)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">library</span>(raster)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">library</span>(velox)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw">library</span>(smoothr)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw">library</span>(rnaturalearth)</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="kw">library</span>(tidyr)</a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="kw">library</span>(stringr)</a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="co"># resolve namespace conflicts</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12">select &lt;-<span class="st"> </span>dplyr<span class="op">::</span>select</a></code></pre></div>
</div>
<div id="data-download" class="section level1">
<h1>Data Download</h1>
<p>Before we do anything else, we’ll need to download and load the example abundance data for Yellow-bellied Sapsucker.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># download to a temp directory for the vigette</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co"># in practice, change to permanent directory the status and trends downloads</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">sp_path &lt;-<span class="st"> </span><span class="kw">ebirdst_download</span>(<span class="dt">species =</span> <span class="st">&quot;example_data&quot;</span>)</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="co"># load the abundance data</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="co"># this automaticaaly labels layers with their dates</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">abd &lt;-<span class="st"> </span><span class="kw">load_raster</span>(<span class="st">&quot;abundance_umean&quot;</span>, <span class="dt">path =</span> sp_path)</a></code></pre></div>
<p>The abundance data now consist of a <code>RasterStack</code> object with 52 layers, each corresponding to the relative abundance for a single week.</p>
<p>We’ll also need some additional spatial data (state and country borders, lakes, etc.) to provide context for the maps we’ll make. <a href="https://www.naturalearthdata.com/">Natural Earth</a> is the best source for free map data and there’s an associated R package (<code>rnaturalearth</code>) for accessing the data. For all the maps in this vignette, we’ll use the <a href="https://en.wikipedia.org/wiki/Mollweide_projection">Mollweide projection</a>, an excellent option for continental scale maps.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">mollweide &lt;-<span class="st"> &quot;+proj=moll +lon_0=-90 +x_0=0 +y_0=0 +ellps=WGS84&quot;</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">ne_scale &lt;-<span class="st"> </span><span class="dv">50</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co"># land polygon</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5">ne_land &lt;-<span class="st"> </span><span class="kw">ne_countries</span>(<span class="dt">scale =</span> ne_scale, <span class="dt">returnclass =</span> <span class="st">&quot;sf&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="st">  </span><span class="kw">filter</span>(continent <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;North America&quot;</span>, <span class="st">&quot;South America&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="st">  </span><span class="kw">st_set_precision</span>(<span class="fl">1e6</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="st">  </span><span class="kw">st_union</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="st">  </span><span class="kw">st_geometry</span>()</a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="co"># function to subset other features to those  within this land area</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11">wh_subset &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">  in_wh &lt;-<span class="st"> </span><span class="kw">as.logical</span>(<span class="kw">st_intersects</span>(x, ne_land, <span class="dt">sparse =</span> <span class="ot">FALSE</span>))</a>
<a class="sourceLine" id="cb3-13" data-line-number="13">  <span class="kw">st_transform</span>(x[in_wh], <span class="dt">crs =</span> mollweide)</a>
<a class="sourceLine" id="cb3-14" data-line-number="14">}</a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="co"># country lines</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16">ne_country_lines &lt;-<span class="st"> </span><span class="kw">ne_download</span>(<span class="dt">scale =</span> ne_scale, <span class="dt">category =</span> <span class="st">&quot;cultural&quot;</span>,</a>
<a class="sourceLine" id="cb3-17" data-line-number="17">                                <span class="dt">type =</span> <span class="st">&quot;admin_0_boundary_lines_land&quot;</span>,</a>
<a class="sourceLine" id="cb3-18" data-line-number="18">                                <span class="dt">returnclass =</span> <span class="st">&quot;sf&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19"><span class="st">  </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-20" data-line-number="20"><span class="st">  </span><span class="kw">wh_subset</span>()</a>
<a class="sourceLine" id="cb3-21" data-line-number="21"><span class="co"># state lines</span></a>
<a class="sourceLine" id="cb3-22" data-line-number="22">ne_state_lines &lt;-<span class="st"> </span><span class="kw">ne_download</span>(<span class="dt">scale =</span> ne_scale, <span class="dt">category =</span> <span class="st">&quot;cultural&quot;</span>,</a>
<a class="sourceLine" id="cb3-23" data-line-number="23">                              <span class="dt">type =</span> <span class="st">&quot;admin_1_states_provinces_lines&quot;</span>,</a>
<a class="sourceLine" id="cb3-24" data-line-number="24">                              <span class="dt">returnclass =</span> <span class="st">&quot;sf&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-25" data-line-number="25"><span class="st">  </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-26" data-line-number="26"><span class="st">  </span><span class="kw">wh_subset</span>()</a>
<a class="sourceLine" id="cb3-27" data-line-number="27"><span class="co"># rivers</span></a>
<a class="sourceLine" id="cb3-28" data-line-number="28">ne_rivers &lt;-<span class="st"> </span><span class="kw">ne_download</span>(<span class="dt">scale =</span> ne_scale, <span class="dt">category =</span> <span class="st">&quot;physical&quot;</span>,</a>
<a class="sourceLine" id="cb3-29" data-line-number="29">                         <span class="dt">type =</span> <span class="st">&quot;rivers_lake_centerlines&quot;</span>,</a>
<a class="sourceLine" id="cb3-30" data-line-number="30">                         <span class="dt">returnclass =</span> <span class="st">&quot;sf&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-31" data-line-number="31"><span class="st">  </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-32" data-line-number="32"><span class="st">  </span><span class="kw">wh_subset</span>()</a>
<a class="sourceLine" id="cb3-33" data-line-number="33"><span class="co"># lakes</span></a>
<a class="sourceLine" id="cb3-34" data-line-number="34">ne_lakes &lt;-<span class="st"> </span><span class="kw">ne_download</span>(<span class="dt">scale =</span> ne_scale, <span class="dt">category =</span> <span class="st">&quot;physical&quot;</span>,</a>
<a class="sourceLine" id="cb3-35" data-line-number="35">                        <span class="dt">type =</span> <span class="st">&quot;lakes&quot;</span>,</a>
<a class="sourceLine" id="cb3-36" data-line-number="36">                        <span class="dt">returnclass =</span> <span class="st">&quot;sf&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-37" data-line-number="37"><span class="st">  </span><span class="kw">st_geometry</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-38" data-line-number="38"><span class="st">  </span><span class="kw">wh_subset</span>()</a>
<a class="sourceLine" id="cb3-39" data-line-number="39">ne_land &lt;-<span class="st"> </span><span class="kw">st_transform</span>(ne_land, <span class="dt">crs =</span> mollweide)</a></code></pre></div>
</div>
<div id="seasonal-abundance" class="section level1">
<h1>Seasonal Abundance</h1>
<p>Generally, the seasons for eBird Status and Trends products are defined on a species-specific basis through expert review. For information on the details of defining seasons, please see the <a href="https://ebird.org/science/status-and-trends/faq#seasons">seasons section of the FAQ</a>. While it is certainly possible to define your own seasons when making seasonal abundance and range maps, if you want to recreate the products with the same seasons as the website, you’ll need to use the definitions included in the <code>ebirdst_runs</code> data frame included in this package.</p>
<p>Let’s start by getting the seasonal definitions for Yellow-bellied Sapsucker and transforming the data into a more usable format. For some species, expert review may have indicated that the models are poor in certain seasons. These problematic seasons are identified by missing dates in <code>ebirdst_runs</code> for the season in question. Although all seasons passed review for Yellow-bellied Sapsucker, for generality I’ll add an additional column (<code>passed</code>) indicating whether a seasonal model passed review.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># subset to the yellow-bellied sapsucker season definitions</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">yebsap_dates &lt;-<span class="st"> </span><span class="kw">filter</span>(ebirdst_runs, species_code <span class="op">==</span><span class="st"> &quot;yebsap&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="st">  </span><span class="co"># just keep the seasonal definition columns</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(<span class="kw">setdiff</span>(<span class="kw">matches</span>(<span class="st">&quot;(start)|(end)&quot;</span>), <span class="kw">matches</span>(<span class="st">&quot;year_round&quot;</span>))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="st">  </span><span class="co"># transpose</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="st">  </span><span class="kw">gather</span>(<span class="st">&quot;label&quot;</span>, <span class="st">&quot;date&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="st">  </span><span class="co"># spread data so start and end dates are in separate columns</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="st">  </span><span class="kw">separate</span>(label, <span class="kw">c</span>(<span class="st">&quot;season&quot;</span>, <span class="st">&quot;start_end&quot;</span>), <span class="st">&quot;_(?=s|e)&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="st">  </span><span class="kw">spread</span>(start_end, date) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="st">  </span><span class="kw">select</span>(season, start_dt, end_dt)</a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="co"># did the season pass review</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12">yebsap_dates &lt;-<span class="st"> </span><span class="kw">mutate</span>(yebsap_dates, <span class="dt">pass =</span> <span class="op">!</span>(<span class="kw">is.na</span>(start_dt) <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(end_dt)))</a>
<a class="sourceLine" id="cb4-13" data-line-number="13">yebsap_dates</a></code></pre></div>
<p>Now, we’ll use these season definitions to assign each of the weekly abundance layers to a season.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># dates for each abundance layer</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">weeks &lt;-<span class="st"> </span><span class="kw">parse_raster_dates</span>(abd)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co"># assign to seasons</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">weeks_season &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="ot">NA_character_</span>, <span class="kw">length</span>(weeks))</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_len</span>(<span class="kw">nrow</span>(yebsap_dates))) {</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  s &lt;-<span class="st"> </span>yebsap_dates[i, ]</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">  <span class="co"># skip seasona assignment if season failed</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8">  <span class="cf">if</span> (<span class="op">!</span>s<span class="op">$</span>pass) {</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">    <span class="cf">next</span>()</a>
<a class="sourceLine" id="cb5-10" data-line-number="10">  }</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">  <span class="co"># handle seasons cross jan 1 separately</span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12">  <span class="cf">if</span> (s<span class="op">$</span>start_dt <span class="op">&lt;=</span><span class="st"> </span>s<span class="op">$</span>end_dt) {</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">    in_season &lt;-<span class="st"> </span>weeks <span class="op">&gt;=</span><span class="st"> </span>s<span class="op">$</span>start_dt <span class="op">&amp;</span><span class="st"> </span>weeks <span class="op">&lt;=</span><span class="st"> </span>s<span class="op">$</span>end_dt</a>
<a class="sourceLine" id="cb5-14" data-line-number="14">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb5-15" data-line-number="15">    in_season &lt;-<span class="st"> </span>weeks <span class="op">&gt;=</span><span class="st"> </span>s<span class="op">$</span>start_dt <span class="op">|</span><span class="st"> </span>weeks <span class="op">&lt;=</span><span class="st"> </span>s<span class="op">$</span>end_dt</a>
<a class="sourceLine" id="cb5-16" data-line-number="16">  }</a>
<a class="sourceLine" id="cb5-17" data-line-number="17">  weeks_season[in_season] &lt;-<span class="st"> </span>s<span class="op">$</span>season</a>
<a class="sourceLine" id="cb5-18" data-line-number="18">}</a>
<a class="sourceLine" id="cb5-19" data-line-number="19"><span class="kw">table</span>(weeks_season)</a></code></pre></div>
<p>Finally, let’s average all the weeks within each season to produce seasonal relative abundance rasters.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># drop weeks not assigned to season</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">week_pass &lt;-<span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(weeks_season)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">abd &lt;-<span class="st"> </span>abd[[<span class="kw">which</span>(week_pass)]]</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">weeks &lt;-<span class="st"> </span>weeks[week_pass]</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">weeks_season &lt;-<span class="st"> </span>weeks_season[week_pass]</a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="co"># average over weeks in season</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7">mean_season &lt;-<span class="st"> </span><span class="cf">function</span>(s) {</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">  <span class="kw">calc</span>(abd[[<span class="kw">which</span>(weeks_season <span class="op">==</span><span class="st"> </span>s)]], mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb6-10" data-line-number="10">seasons &lt;-<span class="st"> </span><span class="kw">unique</span>(weeks_season)</a>
<a class="sourceLine" id="cb6-11" data-line-number="11">abd_season &lt;-<span class="st"> </span><span class="kw">lapply</span>(seasons, mean_season) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12"><span class="st">  </span><span class="kw">stack</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13"><span class="st">  </span><span class="kw">setNames</span>(seasons)</a>
<a class="sourceLine" id="cb6-14" data-line-number="14">abd_season</a></code></pre></div>
</div>
<div id="abundance-maps" class="section level1">
<h1>Abundance Maps</h1>
<p>Before we create maps of seasonal relative abundance we need to account for two addition considerations that the online maps make: whether to split pre- and post-breeding migration and whether to explicitly show the year-round distribution as a separate color. For species that use different paths for their two migrations (less than 40% overlap) we show pre-breeding migration (green) and post-breeding migration (yellow) separately.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">migration_threshold &lt;-<span class="st"> </span><span class="fl">0.4</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">mig_seasons &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;prebreeding_migration&quot;</span>, <span class="st">&quot;postbreeding_migration&quot;</span>)</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="cf">if</span> (<span class="kw">all</span>(mig_seasons <span class="op">%in%</span><span class="st"> </span><span class="kw">names</span>(abd_season))) {</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">  <span class="co"># identify areas with abundance in only one season</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">  abd_nz &lt;-<span class="st"> </span>abd_season[[mig_seasons]] <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6">  just_pre &lt;-<span class="st"> </span><span class="kw">mask</span>(abd_nz[[<span class="st">&quot;prebreeding_migration&quot;</span>]],</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">                   abd_nz[[<span class="st">&quot;postbreeding_migration&quot;</span>]], </a>
<a class="sourceLine" id="cb7-8" data-line-number="8">                   <span class="dt">maskvalue =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">  just_post &lt;-<span class="st"> </span><span class="kw">mask</span>(abd_nz[[<span class="st">&quot;postbreeding_migration&quot;</span>]],</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">                   abd_nz[[<span class="st">&quot;prebreeding_migration&quot;</span>]], </a>
<a class="sourceLine" id="cb7-11" data-line-number="11">                   <span class="dt">maskvalue =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb7-12" data-line-number="12">  <span class="co"># count the number of cells with abundance in only one season</span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13">  n_just &lt;-<span class="st"> </span><span class="kw">cellStats</span>(<span class="kw">stack</span>(just_pre, just_post), sum)</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">  n_all &lt;-<span class="st"> </span><span class="kw">cellStats</span>(abd_nz, sum)</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">  <span class="co"># is the proportion of one season cells above the 40% threshold</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16">  split_migration &lt;-<span class="st"> </span><span class="kw">max</span>(n_just <span class="op">/</span><span class="st"> </span>n_all, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">&gt;=</span><span class="st"> </span>migration_threshold</a>
<a class="sourceLine" id="cb7-17" data-line-number="17">} <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb7-18" data-line-number="18">  split_migration &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb7-19" data-line-number="19">}</a>
<a class="sourceLine" id="cb7-20" data-line-number="20">n_just <span class="op">/</span><span class="st"> </span>n_all</a>
<a class="sourceLine" id="cb7-21" data-line-number="21">split_migration</a></code></pre></div>
<p>In this case, there is essentially complete overlap between pre- and post-breeding migration, so we won’t split them into separate colors on the map. Next, we’ll calculate the average annual abundance, which we’ll display as a separate color if at least 1% of the range is occupied in all four seasons.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">threshold_yearround &lt;-<span class="st"> </span><span class="fl">0.01</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="co"># decide whether to show year-round layer</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="cf">if</span> (<span class="kw">nlayers</span>(abd_season) <span class="op">==</span><span class="st"> </span><span class="dv">4</span>) {</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">  <span class="co"># annual abundance</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">  abd_yr &lt;-<span class="st"> </span><span class="kw">calc</span>(abd, <span class="dt">fun =</span> mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">  <span class="co"># mask out cells that aren't occupied year-round</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7">  year_round &lt;-<span class="st"> </span><span class="kw">calc</span>(abd_season <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="dt">fun =</span> sum, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">==</span><span class="st"> </span><span class="dv">4</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8">  abd_yr_mask &lt;-<span class="st"> </span><span class="kw">mask</span>(abd_yr, year_round, <span class="dt">maskvalue =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb8-9" data-line-number="9">  <span class="co"># determine proportion of celss that are occupied year round</span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10">  n_yr &lt;-<span class="st"> </span><span class="kw">cellStats</span>(abd_yr_mask <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, sum)</a>
<a class="sourceLine" id="cb8-11" data-line-number="11">  n_an &lt;-<span class="st"> </span><span class="kw">cellStats</span>(abd_yr <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, sum)</a>
<a class="sourceLine" id="cb8-12" data-line-number="12">  <span class="co"># only show year round abundance if it's above 1% of range threshold</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13">  show_yearround &lt;-<span class="st"> </span>((n_yr <span class="op">/</span><span class="st"> </span>n_an) <span class="op">&gt;=</span><span class="st"> </span>threshold_yearround)</a>
<a class="sourceLine" id="cb8-14" data-line-number="14">} <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb8-15" data-line-number="15">  show_yearround &lt;-<span class="st"> </span><span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-16" data-line-number="16">}</a>
<a class="sourceLine" id="cb8-17" data-line-number="17">show_yearround</a></code></pre></div>
<p>Mapping relative abundance across the full-annual cycle requires a specialized set of color bins in order to ensure the full range of abundance values is effectively displayed. The function <code>calc_bins()</code> calculates the optimal break points of bins for Status and Trends abundance data.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">bin_breaks &lt;-<span class="st"> </span><span class="kw">calc_bins</span>(abd_season)</a></code></pre></div>
<p>Now that everything is in place, we can actually make the seasonal relative abundance map! Note that the Status and Trends maps distinguish between regions of zero abundance and <a href="https://ebird.org/science/status-and-trends/faq#no-prediction">regions with no prediction</a>, which are displayed in different shades of gray, and regions with non-zero abundance, shown in color. To account for this, we’ll need to generate a raster layer delineating the region within which predictions were made.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># project the abundance data to mollweide</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="co"># use nearest neighbour resampling to preserve true zeros</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">abd_season_proj &lt;-<span class="st"> </span><span class="kw">projectRaster</span>(abd_season, <span class="dt">crs =</span> mollweide, <span class="dt">method =</span> <span class="st">&quot;ngb&quot;</span>)</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="co"># determine spatial extent for plotting</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5">ext &lt;-<span class="st"> </span><span class="kw">calc_full_extent</span>(abd_season_proj)</a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="co"># set the plotting order of the seasons</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">season_order &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;postbreeding_migration&quot;</span>, <span class="st">&quot;prebreeding_migration&quot;</span>, </a>
<a class="sourceLine" id="cb10-8" data-line-number="8">                  <span class="st">&quot;nonbreeding&quot;</span>, <span class="st">&quot;breeding&quot;</span>)</a>
<a class="sourceLine" id="cb10-9" data-line-number="9"></a>
<a class="sourceLine" id="cb10-10" data-line-number="10"><span class="co"># prediction region, cells with predicted value in at least one week</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11">pred_region &lt;-<span class="st"> </span><span class="kw">calc</span>(abd_season_proj, mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb10-12" data-line-number="12"><span class="co"># mask to land area</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13">ne_land_buffer &lt;-<span class="st"> </span><span class="kw">st_buffer</span>(ne_land, <span class="dt">dist =</span> <span class="kw">max</span>(<span class="kw">res</span>(pred_region)) <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb10-14" data-line-number="14">pred_region &lt;-<span class="st"> </span><span class="kw">mask</span>(pred_region, <span class="kw">as_Spatial</span>(ne_land_buffer))</a>
<a class="sourceLine" id="cb10-15" data-line-number="15"></a>
<a class="sourceLine" id="cb10-16" data-line-number="16"><span class="co"># remove zeros from abundnace layers</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17">abd_no_zero &lt;-<span class="st"> </span><span class="kw">subs</span>(abd_season_proj, <span class="kw">data.frame</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="ot">NA</span>), </a>
<a class="sourceLine" id="cb10-18" data-line-number="18">                    <span class="dt">subsWithNA =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb10-19" data-line-number="19"></a>
<a class="sourceLine" id="cb10-20" data-line-number="20"><span class="co"># set up plot area</span></a>
<a class="sourceLine" id="cb10-21" data-line-number="21"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span> , <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb10-22" data-line-number="22"><span class="kw">plot</span>(ne_land, <span class="dt">col =</span> <span class="st">&quot;#eeeeee&quot;</span>, <span class="dt">border =</span> <span class="ot">NA</span>, </a>
<a class="sourceLine" id="cb10-23" data-line-number="23">     <span class="dt">xlim =</span> <span class="kw">c</span>(ext<span class="op">@</span>xmin, ext<span class="op">@</span>xmax),</a>
<a class="sourceLine" id="cb10-24" data-line-number="24">     <span class="dt">ylim =</span> <span class="kw">c</span>(ext<span class="op">@</span>ymin, ext<span class="op">@</span>ymax))</a>
<a class="sourceLine" id="cb10-25" data-line-number="25"><span class="co"># prediction region and explicit zeros</span></a>
<a class="sourceLine" id="cb10-26" data-line-number="26"><span class="kw">plot</span>(pred_region, <span class="dt">col =</span> <span class="st">&quot;#dddddd&quot;</span>, <span class="dt">maxpixels =</span> raster<span class="op">::</span><span class="kw">ncell</span>(pred_region),</a>
<a class="sourceLine" id="cb10-27" data-line-number="27">     <span class="dt">legend =</span> <span class="ot">FALSE</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb10-28" data-line-number="28"><span class="co"># lakes</span></a>
<a class="sourceLine" id="cb10-29" data-line-number="29"><span class="kw">plot</span>(ne_lakes, <span class="dt">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="dt">border =</span>  <span class="st">&quot;#444444&quot;</span>, <span class="dt">lwd =</span> <span class="fl">0.5</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb10-30" data-line-number="30"><span class="co"># land border</span></a>
<a class="sourceLine" id="cb10-31" data-line-number="31"><span class="kw">plot</span>(ne_land, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&quot;#444444&quot;</span>, <span class="dt">lwd =</span> <span class="fl">0.5</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb10-32" data-line-number="32"><span class="co"># seasonal layer</span></a>
<a class="sourceLine" id="cb10-33" data-line-number="33">plot_seasons &lt;-<span class="st"> </span><span class="kw">intersect</span>(season_order, <span class="kw">names</span>(abd_no_zero))</a>
<a class="sourceLine" id="cb10-34" data-line-number="34"><span class="cf">for</span> (s <span class="cf">in</span> plot_seasons) {</a>
<a class="sourceLine" id="cb10-35" data-line-number="35">  <span class="co"># handle splitting of migration seasons into different colors</span></a>
<a class="sourceLine" id="cb10-36" data-line-number="36">  <span class="cf">if</span> (<span class="op">!</span>split_migration <span class="op">&amp;&amp;</span><span class="st"> </span>s <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;prebreeding_migration&quot;</span>, </a>
<a class="sourceLine" id="cb10-37" data-line-number="37">                                   <span class="st">&quot;postbreeding_migration&quot;</span>)) {</a>
<a class="sourceLine" id="cb10-38" data-line-number="38">    pal_season &lt;-<span class="st"> &quot;migration&quot;</span></a>
<a class="sourceLine" id="cb10-39" data-line-number="39">    </a>
<a class="sourceLine" id="cb10-40" data-line-number="40">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb10-41" data-line-number="41">    pal_season &lt;-<span class="st"> </span>s</a>
<a class="sourceLine" id="cb10-42" data-line-number="42">  }</a>
<a class="sourceLine" id="cb10-43" data-line-number="43">  pal &lt;-<span class="st"> </span><span class="kw">abundance_palette</span>(<span class="kw">length</span>(bin_breaks<span class="op">$</span>bins) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, pal_season)</a>
<a class="sourceLine" id="cb10-44" data-line-number="44">  <span class="kw">plot</span>(abd_no_zero[[s]], <span class="dt">col =</span> pal, <span class="dt">breaks =</span> bin_breaks<span class="op">$</span>bins,</a>
<a class="sourceLine" id="cb10-45" data-line-number="45">       <span class="dt">maxpixels =</span> <span class="kw">ncell</span>(abd_no_zero[[s]]),</a>
<a class="sourceLine" id="cb10-46" data-line-number="46">       <span class="dt">legend =</span> <span class="ot">FALSE</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb10-47" data-line-number="47">}</a>
<a class="sourceLine" id="cb10-48" data-line-number="48"><span class="co"># year round</span></a>
<a class="sourceLine" id="cb10-49" data-line-number="49"><span class="cf">if</span> (show_yearround) {</a>
<a class="sourceLine" id="cb10-50" data-line-number="50">  year_round_proj &lt;-<span class="st"> </span><span class="kw">projectRaster</span>(year_round, <span class="dt">crs =</span> mollweide, <span class="dt">method =</span> <span class="st">&quot;ngb&quot;</span>)</a>
<a class="sourceLine" id="cb10-51" data-line-number="51">  <span class="kw">plot</span>(year_round_proj, </a>
<a class="sourceLine" id="cb10-52" data-line-number="52">       <span class="dt">col =</span> <span class="kw">abundance_palette</span>(<span class="kw">length</span>(bin_breaks<span class="op">$</span>bins) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, <span class="st">&quot;year_round&quot;</span>), </a>
<a class="sourceLine" id="cb10-53" data-line-number="53">       <span class="dt">breaks =</span> bin_breaks<span class="op">$</span>bins,</a>
<a class="sourceLine" id="cb10-54" data-line-number="54">       <span class="dt">maxpixels =</span> <span class="kw">ncell</span>(year_round_proj),</a>
<a class="sourceLine" id="cb10-55" data-line-number="55">       <span class="dt">legend =</span> <span class="ot">FALSE</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb10-56" data-line-number="56">}</a>
<a class="sourceLine" id="cb10-57" data-line-number="57"><span class="co"># linework</span></a>
<a class="sourceLine" id="cb10-58" data-line-number="58"><span class="kw">plot</span>(ne_rivers, <span class="dt">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="dt">lwd =</span> <span class="fl">0.75</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb10-59" data-line-number="59"><span class="kw">plot</span>(ne_state_lines, <span class="dt">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="dt">lwd =</span> <span class="fl">1.5</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb10-60" data-line-number="60"><span class="kw">plot</span>(ne_country_lines, <span class="dt">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb10-61" data-line-number="61"></a>
<a class="sourceLine" id="cb10-62" data-line-number="62"><span class="co"># legends</span></a>
<a class="sourceLine" id="cb10-63" data-line-number="63">legend_seasons &lt;-<span class="st"> </span>plot_seasons</a>
<a class="sourceLine" id="cb10-64" data-line-number="64"><span class="cf">if</span> (split_migration) {</a>
<a class="sourceLine" id="cb10-65" data-line-number="65">  legend_seasons[legend_seasons <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;prebreeding_migration&quot;</span>, </a>
<a class="sourceLine" id="cb10-66" data-line-number="66">                                       <span class="st">&quot;postbreeding_migration&quot;</span>)] &lt;-<span class="st"> &quot;migration&quot;</span></a>
<a class="sourceLine" id="cb10-67" data-line-number="67">  legend_seasons &lt;-<span class="st"> </span><span class="kw">unique</span>(legend_seasons)</a>
<a class="sourceLine" id="cb10-68" data-line-number="68">}</a>
<a class="sourceLine" id="cb10-69" data-line-number="69"><span class="cf">if</span> (show_yearround) {</a>
<a class="sourceLine" id="cb10-70" data-line-number="70">  legend_seasons &lt;-<span class="st"> </span><span class="kw">c</span>(legend_seasons, <span class="st">&quot;year_round&quot;</span>)</a>
<a class="sourceLine" id="cb10-71" data-line-number="71">}</a>
<a class="sourceLine" id="cb10-72" data-line-number="72"><span class="co"># thin out labels</span></a>
<a class="sourceLine" id="cb10-73" data-line-number="73">lbl_at &lt;-<span class="st"> </span>bin_breaks<span class="op">$</span>bins<span class="op">^</span>bin_breaks<span class="op">$</span>power</a>
<a class="sourceLine" id="cb10-74" data-line-number="74">lbl_at &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">min</span>(lbl_at), <span class="kw">median</span>(lbl_at), <span class="kw">max</span>(lbl_at))</a>
<a class="sourceLine" id="cb10-75" data-line-number="75">lbl &lt;-<span class="st"> </span>lbl_at<span class="op">^</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>bin_breaks<span class="op">$</span>power)</a>
<a class="sourceLine" id="cb10-76" data-line-number="76">lbl &lt;-<span class="st"> </span><span class="kw">format</span>(<span class="kw">round</span>(lbl, <span class="dv">2</span>), <span class="dt">nsmall =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb10-77" data-line-number="77"><span class="co"># plot legends</span></a>
<a class="sourceLine" id="cb10-78" data-line-number="78"><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_along</span>(legend_seasons)) {</a>
<a class="sourceLine" id="cb10-79" data-line-number="79">  pal &lt;-<span class="st"> </span><span class="kw">abundance_palette</span>(<span class="kw">length</span>(bin_breaks<span class="op">$</span>bins) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, legend_seasons[i])</a>
<a class="sourceLine" id="cb10-80" data-line-number="80">  <span class="cf">if</span> (i <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb10-81" data-line-number="81">    axis_args &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">at =</span> lbl_at, <span class="dt">labels =</span> lbl, <span class="dt">line =</span> <span class="dv">-1</span>,</a>
<a class="sourceLine" id="cb10-82" data-line-number="82">                      <span class="dt">cex.axis =</span> <span class="fl">0.75</span>, <span class="dt">lwd =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb10-83" data-line-number="83">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb10-84" data-line-number="84">    axis_args &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">at =</span> lbl_at, <span class="dt">labels =</span> <span class="kw">rep</span>(<span class="st">&quot;&quot;</span>, <span class="dv">3</span>),</a>
<a class="sourceLine" id="cb10-85" data-line-number="85">                      <span class="dt">cex.axis =</span> <span class="fl">0.75</span>, <span class="dt">lwd =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb10-86" data-line-number="86">  }</a>
<a class="sourceLine" id="cb10-87" data-line-number="87">  legend_title &lt;-<span class="st"> </span>legend_seasons[i] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-88" data-line-number="88"><span class="st">    </span><span class="kw">str_replace_all</span>(<span class="st">&quot;_&quot;</span>, <span class="st">&quot; &quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-89" data-line-number="89"><span class="st">    </span><span class="kw">str_to_title</span>()</a>
<a class="sourceLine" id="cb10-90" data-line-number="90">  fields<span class="op">::</span><span class="kw">image.plot</span>(<span class="dt">zlim =</span> <span class="kw">range</span>(bin_breaks<span class="op">$</span>bins<span class="op">^</span>bin_breaks<span class="op">$</span>power), </a>
<a class="sourceLine" id="cb10-91" data-line-number="91">                   <span class="dt">legend.only =</span> <span class="ot">TRUE</span>, </a>
<a class="sourceLine" id="cb10-92" data-line-number="92">                   <span class="dt">breaks =</span> bin_breaks<span class="op">$</span>bins<span class="op">^</span>bin_breaks<span class="op">$</span>power, <span class="dt">col =</span> pal,</a>
<a class="sourceLine" id="cb10-93" data-line-number="93">                   <span class="dt">smallplot =</span> <span class="kw">c</span>(<span class="fl">0.05</span>, <span class="fl">0.35</span>, <span class="fl">0.01</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.06</span> <span class="op">*</span><span class="st"> </span>i, <span class="fl">0.03</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.06</span> <span class="op">*</span><span class="st"> </span>i),</a>
<a class="sourceLine" id="cb10-94" data-line-number="94">                   <span class="dt">horizontal =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb10-95" data-line-number="95">                   <span class="dt">axis.args =</span> axis_args,</a>
<a class="sourceLine" id="cb10-96" data-line-number="96">                   <span class="dt">legend.args =</span> <span class="kw">list</span>(<span class="dt">text =</span> legend_title, <span class="dt">side =</span> <span class="dv">3</span>, </a>
<a class="sourceLine" id="cb10-97" data-line-number="97">                                      <span class="dt">cex =</span> <span class="fl">0.9</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">line =</span> <span class="fl">0.1</span>))</a>
<a class="sourceLine" id="cb10-98" data-line-number="98">}</a>
<a class="sourceLine" id="cb10-99" data-line-number="99"><span class="kw">title</span>(<span class="st">&quot;Yellow-bellied Sapsucker Relative Abundance (birds per km/hr)&quot;</span>, </a>
<a class="sourceLine" id="cb10-100" data-line-number="100">      <span class="dt">line =</span> <span class="dv">-1</span>, <span class="dt">cex.main =</span> <span class="dv">1</span>)</a></code></pre></div>
</div>
<div id="range-maps" class="section level1">
<h1>Range Maps</h1>
<p>The eBird Status and Trends range maps delineate the boundary of regions with non-zero relative abundance for a given species. We’ll start by aggregating the raster layers to a coarser resolution to speed up processing, then convert the boundaries of non-zero abundance regions to polygons. We’ll also convert the prediction areas to polygons so we can distinguish where the species is predicted to not occur from where it was not modeled.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co"># aggregate</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">abd_season_agg &lt;-<span class="st"> </span><span class="kw">aggregate</span>(abd_season_proj, <span class="dt">fact =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="co"># raster to polygon, one season at a time</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4">range &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">pred_area &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="cf">for</span> (s <span class="cf">in</span> <span class="kw">names</span>(abd_season_agg)) {</a>
<a class="sourceLine" id="cb11-7" data-line-number="7">  <span class="co"># range</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8">  range[[s]] &lt;-<span class="st"> </span><span class="kw">rasterToPolygons</span>(abd_season_agg[[s]], </a>
<a class="sourceLine" id="cb11-9" data-line-number="9">                                 <span class="dt">fun =</span> <span class="cf">function</span>(y) {y <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>}, </a>
<a class="sourceLine" id="cb11-10" data-line-number="10">                                 <span class="dt">digits =</span> <span class="dv">6</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11"><span class="st">    </span><span class="kw">st_as_sfc</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-12" data-line-number="12"><span class="st">    </span><span class="co"># combine polygon pieces into a single multipolygon</span></a>
<a class="sourceLine" id="cb11-13" data-line-number="13"><span class="st">    </span><span class="kw">st_set_precision</span>(<span class="fl">1e6</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-14" data-line-number="14"><span class="st">    </span><span class="kw">st_union</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-15" data-line-number="15"><span class="st">    </span><span class="kw">st_sf</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-16" data-line-number="16"><span class="st">    </span><span class="co"># tag layers with season</span></a>
<a class="sourceLine" id="cb11-17" data-line-number="17"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">season =</span> s, <span class="dt">layer =</span> <span class="st">&quot;range&quot;</span>)</a>
<a class="sourceLine" id="cb11-18" data-line-number="18">  <span class="co"># prediction area</span></a>
<a class="sourceLine" id="cb11-19" data-line-number="19">  pred_area[[s]] &lt;-<span class="st"> </span><span class="kw">rasterToPolygons</span>(abd_season_agg[[s]], </a>
<a class="sourceLine" id="cb11-20" data-line-number="20">                                     <span class="dt">fun =</span> <span class="cf">function</span>(y) {<span class="op">!</span><span class="kw">is.na</span>(y)}, </a>
<a class="sourceLine" id="cb11-21" data-line-number="21">                                     <span class="dt">digits =</span> <span class="dv">6</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-22" data-line-number="22"><span class="st">    </span><span class="kw">st_as_sfc</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-23" data-line-number="23"><span class="st">    </span><span class="co"># combine polygon pieces into a single multipolygon</span></a>
<a class="sourceLine" id="cb11-24" data-line-number="24"><span class="st">    </span><span class="kw">st_set_precision</span>(<span class="fl">1e6</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-25" data-line-number="25"><span class="st">    </span><span class="kw">st_union</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-26" data-line-number="26"><span class="st">    </span><span class="kw">st_sf</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb11-27" data-line-number="27"><span class="st">    </span><span class="co"># tag layers with season</span></a>
<a class="sourceLine" id="cb11-28" data-line-number="28"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">season =</span> s, <span class="dt">layer =</span> <span class="st">&quot;prediction_area&quot;</span>)</a>
<a class="sourceLine" id="cb11-29" data-line-number="29">}</a>
<a class="sourceLine" id="cb11-30" data-line-number="30"><span class="co"># combine the sf objects for all seasons</span></a>
<a class="sourceLine" id="cb11-31" data-line-number="31">range &lt;-<span class="st"> </span><span class="kw">rbind</span>(<span class="kw">do.call</span>(rbind, range), <span class="kw">do.call</span>(rbind, pred_area))</a>
<a class="sourceLine" id="cb11-32" data-line-number="32"><span class="kw">row.names</span>(range) &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb11-33" data-line-number="33"><span class="kw">print</span>(range)</a></code></pre></div>
<p>Converting from raster to polygons frequently yields tiny fragments of polygons and jagged polygon edges, which result in maps that aren’t very aesthetically pleasing. To address this, we’ll apply some algorithms from the <code>smoothr</code> package to clean up the polygons.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co"># clean and smooth</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2">cell_area &lt;-<span class="st"> </span>(<span class="fl">1.5</span> <span class="op">*</span><span class="st"> </span><span class="kw">prod</span>(<span class="kw">res</span>(abd_season_agg)))</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">range_smooth &lt;-<span class="st"> </span>range <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="st">  </span><span class="co"># drop fragment polygons smaller than 1.5 times the aggregated cell size</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="st">  </span><span class="kw">drop_crumbs</span>(<span class="dt">threshold =</span> cell_area) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="st">  </span><span class="co"># drop holes in polygons smaller than 1.5 times the aggregated cell size</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="st">  </span><span class="kw">fill_holes</span>(<span class="dt">threshold =</span> cell_area) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="st">  </span><span class="co"># smooth the polygon edges</span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="st">  </span><span class="kw">smooth</span>(<span class="dt">method =</span> <span class="st">&quot;ksmooth&quot;</span>, <span class="dt">smoothness =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="co"># clip zeros to land border, range to buffered land to handle coastal species</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11">range_split &lt;-<span class="st"> </span><span class="kw">split</span>(range_smooth, range_smooth<span class="op">$</span>layer)</a>
<a class="sourceLine" id="cb12-12" data-line-number="12">range_smooth &lt;-<span class="st"> </span><span class="kw">rbind</span>(</a>
<a class="sourceLine" id="cb12-13" data-line-number="13">  <span class="kw">st_intersection</span>(range_split<span class="op">$</span>range, ne_land_buffer),</a>
<a class="sourceLine" id="cb12-14" data-line-number="14">  <span class="kw">st_intersection</span>(range_split<span class="op">$</span>prediction_area, ne_land))</a></code></pre></div>
<p>Finally, we can produce a seasonal range map in a similar fashion to the abundance map above.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co"># range map color palette</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">range_palette &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">nonbreeding =</span> <span class="st">&quot;#1d6996&quot;</span>,</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">                   <span class="dt">prebreeding_migration =</span> <span class="st">&quot;#73af48&quot;</span>,</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">                   <span class="dt">breeding =</span> <span class="st">&quot;#cc503e&quot;</span>,</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">                   <span class="dt">postbreeding_migration =</span> <span class="st">&quot;#edad08&quot;</span>,</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">                   <span class="dt">migration =</span> <span class="st">&quot;#edad08&quot;</span>,</a>
<a class="sourceLine" id="cb13-7" data-line-number="7">                   <span class="dt">year_round =</span> <span class="st">&quot;#6f4070&quot;</span>)</a>
<a class="sourceLine" id="cb13-8" data-line-number="8"></a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="co"># set up plot area</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10"><span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span> , <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb13-11" data-line-number="11"><span class="kw">plot</span>(ne_land, <span class="dt">col =</span> <span class="st">&quot;#eeeeee&quot;</span>, <span class="dt">border =</span> <span class="ot">NA</span>, </a>
<a class="sourceLine" id="cb13-12" data-line-number="12">     <span class="dt">xlim =</span> <span class="kw">c</span>(ext<span class="op">@</span>xmin, ext<span class="op">@</span>xmax),</a>
<a class="sourceLine" id="cb13-13" data-line-number="13">     <span class="dt">ylim =</span> <span class="kw">c</span>(ext<span class="op">@</span>ymin, ext<span class="op">@</span>ymax))</a>
<a class="sourceLine" id="cb13-14" data-line-number="14"><span class="co"># prediction region and explicit zeros</span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15">annual_pred_area &lt;-<span class="st"> </span><span class="kw">filter</span>(range_smooth, layer <span class="op">==</span><span class="st"> &quot;prediction_area&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16"><span class="st">  </span><span class="kw">st_union</span>()</a>
<a class="sourceLine" id="cb13-17" data-line-number="17"><span class="kw">plot</span>(annual_pred_area, <span class="dt">col =</span> <span class="st">&quot;#dddddd&quot;</span>, <span class="dt">border =</span> <span class="ot">NA</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb13-18" data-line-number="18"><span class="co"># lakes</span></a>
<a class="sourceLine" id="cb13-19" data-line-number="19"><span class="kw">plot</span>(ne_lakes, <span class="dt">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="dt">border =</span>  <span class="st">&quot;#444444&quot;</span>, <span class="dt">lwd =</span> <span class="fl">0.5</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb13-20" data-line-number="20"><span class="co"># land border</span></a>
<a class="sourceLine" id="cb13-21" data-line-number="21"><span class="kw">plot</span>(ne_land, <span class="dt">col =</span> <span class="ot">NA</span>, <span class="dt">border =</span> <span class="st">&quot;#444444&quot;</span>, <span class="dt">lwd =</span> <span class="fl">0.5</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb13-22" data-line-number="22"><span class="co"># seasonal layer</span></a>
<a class="sourceLine" id="cb13-23" data-line-number="23"><span class="cf">for</span> (s <span class="cf">in</span> <span class="kw">intersect</span>(season_order, <span class="kw">unique</span>(range_smooth<span class="op">$</span>season))) {</a>
<a class="sourceLine" id="cb13-24" data-line-number="24">  <span class="co"># handle splitting of migration seasons into different colors</span></a>
<a class="sourceLine" id="cb13-25" data-line-number="25">  <span class="cf">if</span> (<span class="op">!</span>split_migration <span class="op">&amp;&amp;</span><span class="st"> </span>s <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;prebreeding_migration&quot;</span>, </a>
<a class="sourceLine" id="cb13-26" data-line-number="26">                                   <span class="st">&quot;postbreeding_migration&quot;</span>)) {</a>
<a class="sourceLine" id="cb13-27" data-line-number="27">    col_season &lt;-<span class="st"> &quot;migration&quot;</span></a>
<a class="sourceLine" id="cb13-28" data-line-number="28">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb13-29" data-line-number="29">    col_season &lt;-<span class="st"> </span>s</a>
<a class="sourceLine" id="cb13-30" data-line-number="30">  }</a>
<a class="sourceLine" id="cb13-31" data-line-number="31">  rng_season &lt;-<span class="st"> </span><span class="kw">filter</span>(range_smooth, season <span class="op">==</span><span class="st"> </span>s, layer <span class="op">==</span><span class="st"> &quot;range&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-32" data-line-number="32"><span class="st">    </span><span class="kw">st_geometry</span>()</a>
<a class="sourceLine" id="cb13-33" data-line-number="33">  <span class="kw">plot</span>(rng_season, <span class="dt">col =</span> range_palette[col_season], <span class="dt">border =</span> <span class="ot">NA</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb13-34" data-line-number="34">}</a>
<a class="sourceLine" id="cb13-35" data-line-number="35"><span class="co"># year round</span></a>
<a class="sourceLine" id="cb13-36" data-line-number="36"><span class="cf">if</span> (show_yearround) {</a>
<a class="sourceLine" id="cb13-37" data-line-number="37">  <span class="co"># find common area between all seasons</span></a>
<a class="sourceLine" id="cb13-38" data-line-number="38">  range_combined &lt;-<span class="st"> </span><span class="kw">filter</span>(range_smooth, layer <span class="op">==</span><span class="st"> &quot;range&quot;</span>)</a>
<a class="sourceLine" id="cb13-39" data-line-number="39">  range_yearround &lt;-<span class="st"> </span>range_combined[<span class="dv">1</span>, ]</a>
<a class="sourceLine" id="cb13-40" data-line-number="40">  range_combined &lt;-<span class="st"> </span>sf<span class="op">::</span><span class="kw">st_geometry</span>(range_combined)</a>
<a class="sourceLine" id="cb13-41" data-line-number="41">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span><span class="kw">length</span>(range_combined)) {</a>
<a class="sourceLine" id="cb13-42" data-line-number="42">    range_yearround &lt;-<span class="st"> </span>sf<span class="op">::</span><span class="kw">st_intersection</span>(range_yearround, range_combined[i])</a>
<a class="sourceLine" id="cb13-43" data-line-number="43">  }</a>
<a class="sourceLine" id="cb13-44" data-line-number="44">  <span class="kw">plot</span>(<span class="kw">st_geometry</span>(range_yearround), </a>
<a class="sourceLine" id="cb13-45" data-line-number="45">       <span class="dt">col =</span> range_palette[<span class="st">&quot;year_round&quot;</span>], <span class="dt">border =</span> <span class="ot">NA</span>, </a>
<a class="sourceLine" id="cb13-46" data-line-number="46">       <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb13-47" data-line-number="47">}</a>
<a class="sourceLine" id="cb13-48" data-line-number="48"><span class="co"># linework</span></a>
<a class="sourceLine" id="cb13-49" data-line-number="49"><span class="kw">plot</span>(ne_rivers, <span class="dt">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="dt">lwd =</span> <span class="fl">0.75</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb13-50" data-line-number="50"><span class="kw">plot</span>(ne_state_lines, <span class="dt">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="dt">lwd =</span> <span class="fl">1.5</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb13-51" data-line-number="51"><span class="kw">plot</span>(ne_country_lines, <span class="dt">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb13-52" data-line-number="52"></a>
<a class="sourceLine" id="cb13-53" data-line-number="53"><span class="co"># legend</span></a>
<a class="sourceLine" id="cb13-54" data-line-number="54">rng_legend &lt;-<span class="st"> </span><span class="kw">rev</span>(range_palette[legend_seasons])</a>
<a class="sourceLine" id="cb13-55" data-line-number="55"><span class="kw">names</span>(rng_legend) &lt;-<span class="st"> </span><span class="kw">names</span>(rng_legend) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-56" data-line-number="56"><span class="st">    </span><span class="kw">str_replace_all</span>(<span class="st">&quot;_&quot;</span>, <span class="st">&quot; &quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-57" data-line-number="57"><span class="st">    </span><span class="kw">str_to_title</span>()</a>
<a class="sourceLine" id="cb13-58" data-line-number="58"><span class="kw">legend</span>(<span class="st">&quot;bottomleft&quot;</span>, <span class="dt">legend =</span> <span class="kw">names</span>(rng_legend), <span class="dt">fill =</span> rng_legend)</a>
<a class="sourceLine" id="cb13-59" data-line-number="59"><span class="kw">title</span>(<span class="st">&quot;Yellow-bellied Sapsucker Seasonal Range Map&quot;</span>, </a>
<a class="sourceLine" id="cb13-60" data-line-number="60">      <span class="dt">line =</span> <span class="dv">-1</span>, <span class="dt">cex.main =</span> <span class="dv">1</span>)</a></code></pre></div>
</div>
<div id="regional-statistics" class="section level1">
<h1>Regional Statistics</h1>
<p>In addition to maps and visualizations, the eBird Status and Trends website provides a set of statistics summarizing the spatial data over regions. In the US and Canada, statistics are provided for each state and province, and throughout North America they are provided for <a href="http://nabci-us.org/resources/bird-conservation-regions-map/">Bird Conservation Regions (BCRs)</a>. The five regional statistics are:</p>
<ol style="list-style-type: decimal">
<li><strong>Mean relative abundance:</strong> the average estimated relative abundance within the given region for a given season.</li>
<li><strong>Percentage of seasonal North American population:</strong> the sum of the estimated relative abundance within the selected region divided by the sum of the estimated relative abundance across North America.</li>
<li><strong>Percentage of region occupied:</strong> the percentage of the selected region within the range boundary of a species for a given season.</li>
<li><strong>Percentage of North American range in region:</strong> the fraction of a species’ total North American range that falls within the selected region.</li>
<li><strong>Days of occupation in region:</strong> the number of days that a species occupies the selected region, with occupation being defined as spatially covering the selected region by at least 5% based on estimated relative abundances averaged across the given season.</li>
</ol>
<p>These statistics can be <a href="https://ebird.org/science/status-and-trends/download-data">downloaded from the Status and Trends website</a> for all regions and species; however, there may be situations where you want to calculate them over different regions than those provided. With that in mind, this vignette will cover how to calculate a couple of these statistics: mean relative abundance and days of occupation. The remaining 3 statistics can be calculated following the same approach with minor modifications.</p>
<p>Since the example data used in this vignette is restricted to Michigan, we’ll calculate the statistics over the counties in Michigan; however, this approach can easily be extended to any set of regions. Let’s start by downloading county boundaries for Michigan.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">mi_counties &lt;-<span class="st"> </span><span class="kw">getData</span>(<span class="st">&quot;GADM&quot;</span>, <span class="dt">country =</span> <span class="st">&quot;USA&quot;</span>, <span class="dt">level =</span> <span class="dv">2</span>, <span class="dt">path =</span> <span class="kw">tempdir</span>()) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="st">  </span><span class="kw">st_as_sf</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(NAME_<span class="dv">1</span> <span class="op">==</span><span class="st"> &quot;Michigan&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(<span class="dt">county =</span> NAME_<span class="dv">2</span>, <span class="dt">county_code =</span> HASC_<span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> <span class="kw">projection</span>(abd)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="st">  </span><span class="co"># remove lakes which aren't true counties</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="st">  </span><span class="kw">filter</span>(county_code <span class="op">!=</span><span class="st"> &quot;US.MI.WB&quot;</span>)</a></code></pre></div>
<p>We’ll also aggregate the data to coarser resolution to perform these calculations. This isn’t necessary for the example dataset, but when this is extended to the full dataset it will become critical for making these calculations efficiently.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">abd_season_agg &lt;-<span class="st"> </span><span class="kw">aggregate</span>(abd_season, <span class="dt">fact =</span> <span class="dv">3</span>, <span class="dt">fun =</span> mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">abd_agg &lt;-<span class="st"> </span><span class="kw">aggregate</span>(abd, <span class="dt">fact =</span> <span class="dv">3</span>, <span class="dt">fun =</span> mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<div id="mean-relative-abundance" class="section level2">
<h2>Mean Relative Abundance</h2>
<p>Mean relative abundance is the easiest statistics to calculate: we simply average all the raster cells within each region polygon. This could be done with the <code>raster</code> function <code>extract()</code>; however, we’ll <code>extract()</code> from the <code>velox</code> package instead, which is orders of magnitude faster.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">vx &lt;-<span class="st"> </span><span class="kw">velox</span>(abd_season_agg)</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">abd_mean_region &lt;-<span class="st"> </span>vx<span class="op">$</span><span class="kw">extract</span>(mi_counties, </a>
<a class="sourceLine" id="cb16-3" data-line-number="3">                              <span class="dt">fun =</span> <span class="cf">function</span>(x) {<span class="kw">mean</span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)}, </a>
<a class="sourceLine" id="cb16-4" data-line-number="4">                              <span class="dt">df =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5"><span class="st">  </span><span class="co"># assign season names</span></a>
<a class="sourceLine" id="cb16-6" data-line-number="6"><span class="st">  </span><span class="kw">setNames</span>(<span class="kw">c</span>(<span class="st">&quot;id&quot;</span>, <span class="kw">names</span>(abd_season_agg))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"><span class="st">  </span><span class="co"># attach county attributes</span></a>
<a class="sourceLine" id="cb16-8" data-line-number="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">county_code =</span> mi_counties<span class="op">$</span>county_code) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-9" data-line-number="9"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>id)</a>
<a class="sourceLine" id="cb16-10" data-line-number="10"><span class="co"># transpose to one season per row</span></a>
<a class="sourceLine" id="cb16-11" data-line-number="11">abd_mean_region &lt;-<span class="st"> </span>abd_mean_region <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-12" data-line-number="12"><span class="st">  </span><span class="kw">gather</span>(season, mean_abundance, <span class="op">-</span>county_code)</a>
<a class="sourceLine" id="cb16-13" data-line-number="13"><span class="kw">head</span>(abd_mean_region)</a></code></pre></div>
<p>Let’s make a quick map comparing the breeding and non-breeding mean relative abundance within counties in Michigan.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="co"># join back to county boundaries</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2">abd_mean_proj &lt;-<span class="st"> </span>abd_mean_region <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="st">  </span><span class="kw">inner_join</span>(mi_counties, ., <span class="dt">by =</span> <span class="st">&quot;county_code&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4"><span class="st">  </span><span class="co"># transform to mollweide for plotting</span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5"><span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> mollweide)</a>
<a class="sourceLine" id="cb17-6" data-line-number="6"></a>
<a class="sourceLine" id="cb17-7" data-line-number="7"><span class="co"># plot</span></a>
<a class="sourceLine" id="cb17-8" data-line-number="8"><span class="kw">ggplot</span>(abd_mean_proj <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(season <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;breeding&quot;</span>, <span class="st">&quot;nonbreeding&quot;</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-9" data-line-number="9"><span class="st">  </span><span class="co"># abundance data</span></a>
<a class="sourceLine" id="cb17-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_sf</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> mean_abundance)) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-11" data-line-number="11"><span class="st">  </span><span class="kw">scale_fill_viridis_c</span>(<span class="dt">trans =</span> <span class="st">&quot;sqrt&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-12" data-line-number="12"><span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_colorbar</span>(<span class="dt">title.position =</span> <span class="st">&quot;top&quot;</span>, <span class="dt">barwidth =</span> <span class="dv">15</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-13" data-line-number="13"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>season, <span class="dt">ncol =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-14" data-line-number="14"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Seasonal mean relative abundance in MI counties&quot;</span>,</a>
<a class="sourceLine" id="cb17-15" data-line-number="15">       <span class="dt">fill =</span> <span class="st">&quot;Relative abundance&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-16" data-line-number="16"><span class="st">  </span><span class="kw">theme_bw</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb17-17" data-line-number="17"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</a></code></pre></div>
</div>
<div id="days-of-occupation" class="section level2">
<h2>Days of Occupation</h2>
<p>Days of occupation is the most challenging statistic to calculate because it involves several steps. First, for each week, we need to determine if a region (i.e. a county) is “occupied”. We define occupied as at least 5% of the cells within the region having a non-zero abundance.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">threshold_occupied &lt;-<span class="st"> </span><span class="fl">0.05</span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2"></a>
<a class="sourceLine" id="cb18-3" data-line-number="3"><span class="co"># weekly percent occupied</span></a>
<a class="sourceLine" id="cb18-4" data-line-number="4">calc_week_occupied &lt;-<span class="st"> </span><span class="cf">function</span>(wk) {</a>
<a class="sourceLine" id="cb18-5" data-line-number="5">  vx &lt;-<span class="st"> </span><span class="kw">velox</span>(abd_agg[[wk]])</a>
<a class="sourceLine" id="cb18-6" data-line-number="6">  vx<span class="op">$</span><span class="kw">extract</span>(mi_counties, </a>
<a class="sourceLine" id="cb18-7" data-line-number="7">             <span class="dt">fun =</span> <span class="cf">function</span>(x) {<span class="kw">sum</span>(x <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">/</span><span class="st"> </span><span class="kw">length</span>(x)}, </a>
<a class="sourceLine" id="cb18-8" data-line-number="8">             <span class="dt">df =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-9" data-line-number="9"><span class="st">    </span><span class="co"># assign week, season, and county</span></a>
<a class="sourceLine" id="cb18-10" data-line-number="10"><span class="st">    </span><span class="kw">transmute</span>(<span class="dt">week_date =</span> weeks[wk],</a>
<a class="sourceLine" id="cb18-11" data-line-number="11">              <span class="dt">season =</span> weeks_season[wk],</a>
<a class="sourceLine" id="cb18-12" data-line-number="12">              <span class="dt">county_code =</span> mi_counties<span class="op">$</span>county_code,</a>
<a class="sourceLine" id="cb18-13" data-line-number="13">              <span class="dt">pct_occupied =</span> <span class="kw">coalesce</span>(out, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb18-14" data-line-number="14">}</a>
<a class="sourceLine" id="cb18-15" data-line-number="15"><span class="co"># process weeks independently otherwise we'll run into memory issues</span></a>
<a class="sourceLine" id="cb18-16" data-line-number="16">week_occupied &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">seq_len</span>(<span class="kw">nlayers</span>(abd_agg)), calc_week_occupied) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-17" data-line-number="17"><span class="st">  </span><span class="kw">bind_rows</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-18" data-line-number="18"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">occupied =</span> (pct_occupied <span class="op">&gt;</span><span class="st"> </span>threshold_occupied))</a></code></pre></div>
<p>Next, we tally up the number of weeks each region is occupied, then convert to days by multiplying by 7.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">days_occupation &lt;-<span class="st"> </span>week_occupied <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(county_code, season) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-3" data-line-number="3"><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">weeks_occ =</span> <span class="kw">sum</span>(occupied)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-4" data-line-number="4"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">days_occ =</span> <span class="kw">round</span>(<span class="dv">7</span> <span class="op">*</span><span class="st"> </span>weeks_occ)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-6" data-line-number="6"><span class="st">  </span><span class="kw">select</span>(county_code, season, days_occ)</a>
<a class="sourceLine" id="cb19-7" data-line-number="7"><span class="kw">head</span>(days_occupation)</a></code></pre></div>
<p>Finally, let’s produce a map comparing days occupation in the breeding and non-breeding season.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="co"># join back to county boundaries</span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2">days_occ_proj &lt;-<span class="st"> </span>days_occupation <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-3" data-line-number="3"><span class="st">  </span><span class="kw">inner_join</span>(mi_counties, ., <span class="dt">by =</span> <span class="st">&quot;county_code&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-4" data-line-number="4"><span class="st">  </span><span class="co"># transform to mollweide for plotting</span></a>
<a class="sourceLine" id="cb20-5" data-line-number="5"><span class="st">  </span><span class="kw">st_transform</span>(<span class="dt">crs =</span> mollweide)</a>
<a class="sourceLine" id="cb20-6" data-line-number="6"></a>
<a class="sourceLine" id="cb20-7" data-line-number="7"><span class="co"># plot</span></a>
<a class="sourceLine" id="cb20-8" data-line-number="8"><span class="kw">ggplot</span>(days_occ_proj <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(season <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;breeding&quot;</span>, <span class="st">&quot;nonbreeding&quot;</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb20-9" data-line-number="9"><span class="st">  </span><span class="co"># abundance data</span></a>
<a class="sourceLine" id="cb20-10" data-line-number="10"><span class="st">  </span><span class="kw">geom_sf</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> days_occ)) <span class="op">+</span></a>
<a class="sourceLine" id="cb20-11" data-line-number="11"><span class="st">  </span><span class="kw">scale_fill_viridis_c</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb20-12" data-line-number="12"><span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_colorbar</span>(<span class="dt">title.position =</span> <span class="st">&quot;top&quot;</span>, <span class="dt">barwidth =</span> <span class="dv">15</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb20-13" data-line-number="13"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>season, <span class="dt">ncol =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb20-14" data-line-number="14"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Seasonal days of occupation in MI counties&quot;</span>,</a>
<a class="sourceLine" id="cb20-15" data-line-number="15">       <span class="dt">fill =</span> <span class="st">&quot;Days of occupation&quot;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb20-16" data-line-number="16"><span class="st">  </span><span class="kw">theme_bw</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb20-17" data-line-number="17"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</a></code></pre></div>
</div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
