<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>eBird Status Data Products Applications</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">eBird Status Data Products
Applications</h1>



<style type="text/css">
.table {
width: 50%;
}
</style>
<p>This vignette will cover a variety of common applications of the
eBird Status Data Products including producing maps, plotting migration
chronologies, estimating the proportion of the population of a species
within a region, and identifying areas of importance for a suite of
species within a region. Each of these applications is chosen to
highlight the value of the eBird Status Data Products for informing bird
conservation and management.</p>
<p>Since conservation resources are finite, it’s crucial to allocate
them strategically for maximum impact, ensuring resources are precisely
directed to the right place at the right time. The eBird Status Data
Products are particularly valuable for informing these spatiotemporal
conservation decisions because they offer high spatial and temporal
resolution information for a large number of species across their full
global ranges.</p>
<p>In the introductory vignette we worked with the small example dataset
for Yellow-bellied Sapsucker, which does not require a data access key
to download. To provide more realistic examples, throughout this
vignette we will use complete datasets for several species. As a result,
a <a href="https://ebird.github.io/ebirdst/articles/status.html#access">data
access key</a> is required to run the code in this vignette.</p>
<p>A webinar working through several of these applications is a <a href="https://www.youtube.com/watch?v=xduYPkQnbEo">available on
YouTube</a>.</p>
<p>We start by loading the packages used throughout this vignette.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(ebirdst)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">library</span>(fields)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="fu">library</span>(rnaturalearth)</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="fu">library</span>(scico)</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>extract <span class="ot">&lt;-</span> terra<span class="sc">::</span>extract</span></code></pre></div>
<div id="map" class="section level1">
<h1>Mapping relative abundance</h1>
<p>In this section, we’ll demonstrate how to make a simple map of
relative abundance within a given region. As an example, we’ll make a
map of breeding season relative abundance for <a href="https://ebird.org/species/wesmea">Western Meadowlark</a> in
Montana The maps produced using this approach are suitable for many
applications; however, for high-quality publication-ready maps, it may
be worthwhile using a traditional GIS environment such as QGIS or ArcGIS
rather than R.</p>
<p>We start by downloading data for Western Meadowlark and loading the
breeding season relative abundance raster. The <code>pattern</code>
argument to <code>ebirdst_download_status()</code> can be used to only
download the specific files we need.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># download seasonal relative abundance data</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="fu">ebirdst_download_status</span>(<span class="st">&quot;wesmea&quot;</span>,</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>                        <span class="at">pattern =</span> <span class="st">&quot;abundance_seasonal_mean&quot;</span>)</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="co"># load seasonal mean relative abundance at 3km resolution</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>abd_seasonal <span class="ot">&lt;-</span> <span class="fu">load_raster</span>(<span class="st">&quot;wesmea&quot;</span>, </span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>                            <span class="at">product =</span> <span class="st">&quot;abundance&quot;</span>, </span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>                            <span class="at">period =</span> <span class="st">&quot;seasonal&quot;</span>,</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>                            <span class="at">metric =</span> <span class="st">&quot;mean&quot;</span>,</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>                            <span class="at">resolution =</span> <span class="st">&quot;3km&quot;</span>)</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a><span class="co"># extract just the breeding season relative abundance</span></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>abd_breeding <span class="ot">&lt;-</span> abd_seasonal[[<span class="st">&quot;breeding&quot;</span>]]</span></code></pre></div>
<p>The simplest way to map the seasonal relative abundance data is to
use the built in <code>plot()</code> function from the
<code>terra</code> package.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">plot</span>(abd_breeding, <span class="at">axes =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>Clearly this simple approach doesn’t work very well! There are a wide
variety of issues that we’ll tackle one at a time.</p>
<div id="map-extent" class="section level2">
<h2>Cropping and masking</h2>
<p>All raster data downloaded through this package are defined over the
same global grid, regardless of the range of the individual species. As
a result, mapping these data will produce a global map by default.
However, Western Meadowlark only occurs in the western United States,
which is barely visible in the global map. We need to constrain the
extent of our map to make it more useful. For this example, we’ll
download a boundary for Montana (a state in the United States that
harbors a large proportion of the breeding population of Western
Meadowlark) and use it to crop and mask the relative abundance data. If
you have a region defined in a Shapefile or GeoPackage you can instead
load that a polygon defining the boundary of that region using
<code>read_sf()</code>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># region boundary</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>region_boundary <span class="ot">&lt;-</span> <span class="fu">ne_states</span>(<span class="at">iso_a2 =</span> <span class="st">&quot;US&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>  <span class="fu">filter</span>(name <span class="sc">==</span> <span class="st">&quot;Montana&quot;</span>)</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="co"># project boundary to match raster data</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>region_boundary_proj <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(region_boundary, <span class="fu">st_crs</span>(abd_breeding))</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="co"># crop and mask to boundary of montana</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>abd_breeding_mask <span class="ot">&lt;-</span> <span class="fu">crop</span>(abd_breeding, region_boundary_proj) <span class="sc">|&gt;</span> </span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>  <span class="fu">mask</span>(region_boundary_proj)</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a><span class="co"># map the cropped data</span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a><span class="fu">plot</span>(abd_breeding_mask, <span class="at">axes =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
<div id="map-projection" class="section level2">
<h2>Projection</h2>
<p>The raster data are all provided in the same equal area Earth Earth
coordinate reference system. This projection is designed to work for any
location on Earth; however, it is not ideal for mapping smaller regions.
Instead, it’s best to select an equal area projection tailored to your
region. A good general purpose choice is a Lambert’s azimuthal equal
area projection centered on the focal region. This can be defined
programmatically as follows.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># find the centroid of the region</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>region_centroid <span class="ot">&lt;-</span> region_boundary <span class="sc">|&gt;</span> </span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> </span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">|&gt;</span> </span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>  <span class="fu">st_centroid</span>() <span class="sc">|&gt;</span> </span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>  <span class="fu">st_coordinates</span>() <span class="sc">|&gt;</span> </span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>  <span class="fu">round</span>(<span class="dv">1</span>)</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="co"># define projection</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>crs_laea <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;+proj=laea +lat_0=&quot;</span>, region_centroid[<span class="dv">2</span>],</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>                   <span class="st">&quot; +lon_0=&quot;</span>, region_centroid[<span class="dv">1</span>])</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a><span class="co"># transform to the custom projection using nearest neighbor resampling</span></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>abd_breeding_laea <span class="ot">&lt;-</span> <span class="fu">project</span>(abd_breeding_mask, crs_laea, <span class="at">method =</span> <span class="st">&quot;near&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>  <span class="co"># remove areas of the raster containing no data</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>  <span class="fu">trim</span>()</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a><span class="co"># map the cropped and projected data</span></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a><span class="fu">plot</span>(abd_breeding_laea, <span class="at">axes =</span> <span class="cn">FALSE</span>, <span class="at">breakby =</span> <span class="st">&quot;cases&quot;</span>)</span></code></pre></div>
</div>
<div id="map-bins" class="section level2">
<h2>Abundance bins</h2>
<p>The relative abundance data are not uniformly distributed, which can
lead to challenges distinguishing areas of differing levels of
abundance. This is especially true for highly aggregatory species like
shorebirds and ducks. To address this, we’ll use a quantile bins for the
map, where each color in the legend corresponds to an equal number of
cells in the raster. We’ll define these bins excluding zeros, then
assign a separate color to the zeros. We can also use the function
<code>abundance_palette()</code> to get the same set of colors we use in
the legends on the eBird Status and Trends website.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># quantiles of non-zero values</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">values</span>(abd_breeding_laea, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">mat =</span> <span class="cn">FALSE</span>)</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>v <span class="ot">&lt;-</span> v[v <span class="sc">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>breaks <span class="ot">&lt;-</span> <span class="fu">quantile</span>(v, <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.1</span>))</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="co"># add a bin for 0</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>breaks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, breaks)</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="co"># status and trends palette</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">ebirdst_palettes</span>(<span class="fu">length</span>(breaks) <span class="sc">-</span> <span class="dv">2</span>)</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="co"># add a color for zero</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>pal <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;#e6e6e6&quot;</span>, pal)</span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a><span class="co"># map using the quantile bins</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a><span class="fu">plot</span>(abd_breeding_laea, <span class="at">breaks =</span> breaks, <span class="at">col =</span> pal, <span class="at">axes =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
<div id="map-basemap" class="section level2">
<h2>Basemap</h2>
<p>Finally, we’ll add state and country boundaries to provide some
context and generate a nicer legend. The R package
<code>rnaturalearth</code> is an excellent source of attribution free
contextual GIS data.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># natural earth boundaries</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>countries <span class="ot">&lt;-</span> <span class="fu">ne_countries</span>(<span class="at">returnclass =</span> <span class="st">&quot;sf&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>  <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> </span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>  <span class="fu">st_transform</span>(crs_laea)</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>states <span class="ot">&lt;-</span> <span class="fu">ne_states</span>(<span class="at">iso_a2 =</span> <span class="st">&quot;US&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>  <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> </span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>  <span class="fu">st_transform</span>(crs_laea)</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="co"># define the map plotting extent with the region boundary polygon</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>region_boundary_laea <span class="ot">&lt;-</span> region_boundary <span class="sc">|&gt;</span> </span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>  <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> </span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>  <span class="fu">st_transform</span>(crs_laea)</span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a><span class="fu">plot</span>(region_boundary_laea)</span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a><span class="co"># add basemap</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a><span class="fu">plot</span>(countries, <span class="at">col =</span> <span class="st">&quot;#cfcfcf&quot;</span>, <span class="at">border =</span> <span class="st">&quot;#888888&quot;</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a><span class="co"># add relative abundance</span></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a><span class="fu">plot</span>(abd_breeding_laea,</span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>     <span class="at">breaks =</span> breaks, <span class="at">col =</span> pal, </span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a>     <span class="at">maxcell =</span> <span class="fu">ncell</span>(abd_breeding_laea),</span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a>     <span class="at">legend =</span> <span class="cn">FALSE</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a><span class="co"># add boundaries</span></span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">vect</span>(countries), <span class="at">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="at">lwd =</span> <span class="dv">3</span>)</span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">vect</span>(states), <span class="at">col =</span>  <span class="st">&quot;#ffffff&quot;</span>, <span class="at">lwd =</span> <span class="fl">1.5</span>, <span class="at">xpd =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">vect</span>(region_boundary_laea), <span class="at">col =</span> <span class="st">&quot;#ffffff&quot;</span>, <span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">xpd =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-25"><a href="#cb7-25" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" tabindex="-1"></a><span class="co"># add legend using the fields package</span></span>
<span id="cb7-27"><a href="#cb7-27" tabindex="-1"></a><span class="co"># label the bottom, middle, and top</span></span>
<span id="cb7-28"><a href="#cb7-28" tabindex="-1"></a>labels <span class="ot">&lt;-</span> <span class="fu">quantile</span>(breaks, <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>))</span>
<span id="cb7-29"><a href="#cb7-29" tabindex="-1"></a>label_breaks <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="fu">length</span>(breaks))</span>
<span id="cb7-30"><a href="#cb7-30" tabindex="-1"></a><span class="fu">image.plot</span>(<span class="at">zlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">breaks =</span> label_breaks, <span class="at">col =</span> pal,</span>
<span id="cb7-31"><a href="#cb7-31" tabindex="-1"></a>           <span class="at">smallplot =</span> <span class="fu">c</span>(<span class="fl">0.90</span>, <span class="fl">0.93</span>, <span class="fl">0.15</span>, <span class="fl">0.85</span>),</span>
<span id="cb7-32"><a href="#cb7-32" tabindex="-1"></a>           <span class="at">legend.only =</span> <span class="cn">TRUE</span>,</span>
<span id="cb7-33"><a href="#cb7-33" tabindex="-1"></a>           <span class="at">axis.args =</span> <span class="fu">list</span>(<span class="at">at =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>), </span>
<span id="cb7-34"><a href="#cb7-34" tabindex="-1"></a>                            <span class="at">labels =</span> <span class="fu">round</span>(labels, <span class="dv">2</span>),</span>
<span id="cb7-35"><a href="#cb7-35" tabindex="-1"></a>                            <span class="at">col.axis =</span> <span class="st">&quot;black&quot;</span>, <span class="at">fg =</span> <span class="cn">NA</span>,</span>
<span id="cb7-36"><a href="#cb7-36" tabindex="-1"></a>                            <span class="at">cex.axis =</span> <span class="fl">0.9</span>, <span class="at">lwd.ticks =</span> <span class="dv">0</span>,</span>
<span id="cb7-37"><a href="#cb7-37" tabindex="-1"></a>                            <span class="at">line =</span> <span class="sc">-</span><span class="fl">0.5</span>))</span></code></pre></div>
</div>
</div>
<div id="chron" class="section level1">
<h1>Migration chronologies</h1>
<blockquote>
<p><strong>Goal:</strong> generate migration chronologies for a set of
species within a region to investigate how use of the region changes
throughout the year for different species. This information can be used
to inform the optimal time of year to make temporally specific
conservation investments. For an example of this type of conservation
intervention, see the <a href="https://birdreturns.org/">California Bird
Returns project</a>.</p>
</blockquote>
<p>In this application we’ll use the weekly estimates to chart the
change in relative abundance throughout the year for a given region.
These migration chronologies can be useful for identifying when a given
geography receives the highest intensity of use by a species or group of
species.</p>
<p>We’ll start by generating a chronology with confidence intervals for
a single species, then demonstrate how to produce multi-species
chronologies. For these examples, we’ll consider grassland birds in
Montana. To start we’ll load a polygon for the boundary of Montana.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>region_boundary <span class="ot">&lt;-</span> <span class="fu">ne_states</span>(<span class="at">iso_a2 =</span> <span class="st">&quot;US&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  <span class="fu">filter</span>(name <span class="sc">==</span> <span class="st">&quot;Montana&quot;</span>)</span></code></pre></div>
<div id="chron-single" class="section level2">
<h2>Single species with uncertainty</h2>
<p>For the single species example, let’s chart a migration chronology
for <a href="https://ebird.org/species/wesmea">Western Meadowlark</a> in
Montana. First we need to download and load the relevant eBird Status
Data Products for this species: the weekly median relative abundance and
the upper and lower confidence intervals of weekly relative
abundance.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co"># download data if they haven&#39;t already been downloaded</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="co"># only weekly 3km relative abundance, median and confidence limits</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="fu">ebirdst_download_status</span>(<span class="st">&quot;Western Meadowlark&quot;</span>, </span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>                        <span class="at">pattern =</span> <span class="st">&quot;abundance_(median|upper|lower)_3km&quot;</span>)</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="co"># load the median weekly relative abundance and lower/upper confidence limits</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>abd_median <span class="ot">&lt;-</span> <span class="fu">load_raster</span>(<span class="st">&quot;wesmea&quot;</span>, <span class="at">product =</span> <span class="st">&quot;abundance&quot;</span>, <span class="at">metric =</span> <span class="st">&quot;median&quot;</span>)</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>abd_lower <span class="ot">&lt;-</span> <span class="fu">load_raster</span>(<span class="st">&quot;wesmea&quot;</span>, <span class="at">product =</span> <span class="st">&quot;abundance&quot;</span>, <span class="at">metric =</span> <span class="st">&quot;lower&quot;</span>)</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>abd_upper <span class="ot">&lt;-</span> <span class="fu">load_raster</span>(<span class="st">&quot;wesmea&quot;</span>, <span class="at">product =</span> <span class="st">&quot;abundance&quot;</span>, <span class="at">metric =</span> <span class="st">&quot;upper&quot;</span>)</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a><span class="co"># project region boundary to match raster data</span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>region_boundary_proj <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(region_boundary, <span class="fu">st_crs</span>(abd_median))</span></code></pre></div>
<p>Now we can calculate the mean relative abundance with confidence
intervals for each week of the year within Montana The
<code>extract()</code> function extracts all the raster cells values
within a given polygon, then summarizes these values using a
user-provided function.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co"># extract values within region and calculate the mean</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>abd_median_region <span class="ot">&lt;-</span> <span class="fu">extract</span>(abd_median, region_boundary_proj,</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>                             <span class="at">fun =</span> <span class="st">&quot;mean&quot;</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">ID =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>abd_lower_region <span class="ot">&lt;-</span> <span class="fu">extract</span>(abd_lower, region_boundary_proj,</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>                            <span class="at">fun =</span> <span class="st">&quot;mean&quot;</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">ID =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>abd_upper_region <span class="ot">&lt;-</span> <span class="fu">extract</span>(abd_upper, region_boundary_proj,</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>                            <span class="at">fun =</span> <span class="st">&quot;mean&quot;</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">ID =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="co"># transform to data frame format with rows corresponding to weeks</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>chronology <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">week =</span> <span class="fu">as.Date</span>(<span class="fu">names</span>(abd_median)),</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>                         <span class="at">median =</span> <span class="fu">as.numeric</span>(abd_median_region),</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>                         <span class="at">lower =</span> <span class="fu">as.numeric</span>(abd_lower_region),</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>                         <span class="at">upper =</span> <span class="fu">as.numeric</span>(abd_upper_region))</span></code></pre></div>
<p>Finally, let’s use this data frame to generate a migration chronology
for this species.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="fu">ggplot</span>(chronology) <span class="sc">+</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> week, <span class="at">y =</span> median) <span class="sc">+</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper), <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_labels =</span> <span class="st">&quot;%b&quot;</span>, <span class="at">date_breaks =</span> <span class="st">&quot;1 month&quot;</span>) <span class="sc">+</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Week&quot;</span>, </span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Mean relative abundance in Montana&quot;</span>,</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Migration chronology for Western Meadowlark in Montana&quot;</span>)</span></code></pre></div>
</div>
<div id="chron-multi" class="section level2">
<h2>Multi-species</h2>
<p>Migration chronologies can also be overlaid for multiple species,
allowing for comparison of migration timing between species. However,
comparing eBird Status Data Products across species requires extra
caution because the models give <em>relative</em> rather than absolute
abundance. For example, species differ in their detectability, and this
may cause differences in relative abundance. To address this, rather
than use the relative abundance within Kansas, we’ll calculate the
proportion of the global modeled population falling within Kansas. Since
proportion of population is a ratio of relative abundance values, it
helps to control for difference in detectability, allowing us to compare
multiple species.</p>
<p>Following a similar approach to that used for the single species
chronology above, we’ll estimate migration chronologies for a suite of
grassland species in Montana. However, in this example we’ll estimate
the proportion of population falling within Montana rather than the mean
abundance.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>grassland_species <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Baird&#39;s Sparrow&quot;</span>,</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>                       <span class="st">&quot;Bobolink&quot;</span>,</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>                       <span class="st">&quot;Chestnut-collared Longspur&quot;</span>,</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>                       <span class="st">&quot;Sprague&#39;s Pipit&quot;</span>,</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>                       <span class="st">&quot;Upland Sandpiper&quot;</span>,</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>                       <span class="st">&quot;Western Meadowlark&quot;</span>)</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>chronologies <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a><span class="cf">for</span> (species <span class="cf">in</span> grassland_species) {</span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>  <span class="co"># download weekly 27km relative abundance, median and confidence limits</span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>  <span class="fu">ebirdst_download_status</span>(species,</span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>                          <span class="at">pattern =</span> <span class="st">&quot;abundance_(median|upper|lower)_3km&quot;</span>)</span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>  </span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>  <span class="co"># load the median weekly relative abundance and lower/upper confidence limits</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a>  abd_median <span class="ot">&lt;-</span> <span class="fu">load_raster</span>(species)</span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a>  abd_lower <span class="ot">&lt;-</span> <span class="fu">load_raster</span>(species, <span class="at">metric =</span> <span class="st">&quot;lower&quot;</span>)</span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a>  abd_upper <span class="ot">&lt;-</span> <span class="fu">load_raster</span>(species, <span class="at">metric =</span> <span class="st">&quot;upper&quot;</span>)</span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a>  </span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a>  <span class="co"># total relative abundance across the entire modeled range of the species</span></span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a>  abd_total <span class="ot">&lt;-</span> <span class="fu">global</span>(abd_median, <span class="at">fun =</span> sum, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>sum</span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a>  </span>
<span id="cb12-22"><a href="#cb12-22" tabindex="-1"></a>  <span class="co"># total abundance within the region of interest</span></span>
<span id="cb12-23"><a href="#cb12-23" tabindex="-1"></a>  abd_median_region <span class="ot">&lt;-</span> <span class="fu">extract</span>(abd_median, region_boundary_proj,</span>
<span id="cb12-24"><a href="#cb12-24" tabindex="-1"></a>                               <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">ID =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-25"><a href="#cb12-25" tabindex="-1"></a>  abd_lower_region <span class="ot">&lt;-</span> <span class="fu">extract</span>(abd_lower, region_boundary_proj,</span>
<span id="cb12-26"><a href="#cb12-26" tabindex="-1"></a>                              <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">ID =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-27"><a href="#cb12-27" tabindex="-1"></a>  abd_upper_region <span class="ot">&lt;-</span> <span class="fu">extract</span>(abd_upper, region_boundary_proj,</span>
<span id="cb12-28"><a href="#cb12-28" tabindex="-1"></a>                              <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">ID =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-29"><a href="#cb12-29" tabindex="-1"></a>  </span>
<span id="cb12-30"><a href="#cb12-30" tabindex="-1"></a>  <span class="co"># proportion of population within the region of interest</span></span>
<span id="cb12-31"><a href="#cb12-31" tabindex="-1"></a>  prop_pop_median <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(abd_median_region) <span class="sc">/</span> abd_total</span>
<span id="cb12-32"><a href="#cb12-32" tabindex="-1"></a>  prop_pop_lower <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(abd_lower_region) <span class="sc">/</span> abd_total</span>
<span id="cb12-33"><a href="#cb12-33" tabindex="-1"></a>  prop_pop_upper <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(abd_upper_region) <span class="sc">/</span> abd_total</span>
<span id="cb12-34"><a href="#cb12-34" tabindex="-1"></a>  </span>
<span id="cb12-35"><a href="#cb12-35" tabindex="-1"></a>  <span class="co"># transform to data frame format with rows corresponding to weeks</span></span>
<span id="cb12-36"><a href="#cb12-36" tabindex="-1"></a>  chronology <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">species =</span> species,</span>
<span id="cb12-37"><a href="#cb12-37" tabindex="-1"></a>                           <span class="at">week =</span> <span class="fu">as.Date</span>(<span class="fu">names</span>(abd_median)),</span>
<span id="cb12-38"><a href="#cb12-38" tabindex="-1"></a>                           <span class="at">median =</span> prop_pop_median,</span>
<span id="cb12-39"><a href="#cb12-39" tabindex="-1"></a>                           <span class="at">lower =</span> prop_pop_lower,</span>
<span id="cb12-40"><a href="#cb12-40" tabindex="-1"></a>                           <span class="at">upper =</span> <span class="fu">pmin</span>(prop_pop_upper, <span class="dv">1</span>))</span>
<span id="cb12-41"><a href="#cb12-41" tabindex="-1"></a>  </span>
<span id="cb12-42"><a href="#cb12-42" tabindex="-1"></a>  <span class="co"># combine with other species</span></span>
<span id="cb12-43"><a href="#cb12-43" tabindex="-1"></a>  chronologies <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(chronologies, chronology)</span>
<span id="cb12-44"><a href="#cb12-44" tabindex="-1"></a>}</span></code></pre></div>
<p>Finally, we can use this data frame to generate migration
chronologies for these species.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">ggplot</span>(chronologies) <span class="sc">+</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> week, <span class="at">y =</span> median, <span class="at">color =</span> species, <span class="at">fill =</span> species) <span class="sc">+</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper), <span class="at">color =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_labels =</span> <span class="st">&quot;%b&quot;</span>, <span class="at">date_breaks =</span> <span class="st">&quot;1 month&quot;</span>) <span class="sc">+</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>()) <span class="sc">+</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">&quot;Set1&quot;</span>) <span class="sc">+</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">&quot;Set1&quot;</span>) <span class="sc">+</span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, </span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Percent of population in Montana&quot;</span>,</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">&quot;Migration chronologies for grassland birds in Montana&quot;</span>,</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>       <span class="at">color =</span> <span class="cn">NULL</span>, <span class="at">fill =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span></code></pre></div>
<p>A variety of patterns are revealed in this migration chronology.
Several of the grassland species (e.g., Baird’s Sparrow) have more than
30% of their breeding populations entirely within the state of Montana.
Timing of arrival and departure varies between species, with Western
Meadowlark spending the longest amount of time in the state and Bobolink
spending the least amount of time.</p>
<p>Finally, Sprague’s Pipit deserves special attention: there’s a huge
spike in proportion of population during post-breeding migration. Is
this a true reflection of the ecology of this species or an issue with
the model estimates? It’s important to bring a critical eye to outliers
in the data and ask these questions. In this particular case, looking at
the weekly maps on the <a href="https://science.ebird.org/en/status-and-trends/species/sprpip/abundance-map-weekly?week=34">eBird
Status and Trends website</a> for the end of August reveals that the
species appears to almost completely disappears for a couple weeks.
Sprague’s Pipit is quite challenging to detect during migration and it
appears the models are struggling to pick up a signal, resulting in
estimates that are missing large parts of the population. We’ve included
this species as a remind to instigate any irregularities in the
estimates you discover and consult an expert on the species if
needed.</p>
</div>
</div>
<div id="stats" class="section level1">
<h1>Regional proportion of population</h1>
<blockquote>
<p><strong>Goal:</strong> identify the proportion of a species’
population falling within a given region. This information can be used
to highlight stewardship responsibility for a species, for example, if a
large proportion of a species’ breeding populaiton falls within a
region, that region could be said to have a high stewardship
responsibility for that species.</p>
</blockquote>
<p>The eBird Status and Trends website provides regional summary
statistics at the country and state/province level for each species. For
example, we can use the regional stats to see that <a href="https://science.ebird.org/en/status-and-trends/species/goleag/abundance-map?regionCode=USA">33%
of the non-breeding population of Golden Eagle falls within the United
States</a>. The website also allows users to draw their own customs
polygons to get summary statistics within these polygons. However, there
are cases where you may want to estimate regional summary statistics in
a way that isn’t supported by the website. Here we’ll provide a few
examples for calculating the proportion of population within a region.
We’ll use Golden Eagle for these examples.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="fu">ebirdst_download_status</span>(<span class="st">&quot;Golden Eagle&quot;</span>)</span></code></pre></div>
<div id="stats-seasonal" class="section level2">
<h2>Proportion of seasonal population</h2>
<p>For this example, we’ll estimate the seasonal proportion of the
population of Golden Eagle within each state in the United States. Note
that Golden Eagles are distributed throughout the Northern Hemisphere,
in North America, Asia, and Europe. In this example, we’ll be estimating
the proportion of the global population, in the <a href="#stats-regional">next example</a> we’ll estimate the proportion of
the North American population.</p>
<p>To start, we’ll load the seasonal proportion of population raster
layers and polygons defining each state. If you have a Shapefile or
GeoPackage defining your region of interest (e.g., for a protected area
or Bird Conservation Region), you could load it here using the
<code>read_sf()</code> function.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co"># seasonal proportion of population</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>prop_pop_seasonal <span class="ot">&lt;-</span> <span class="fu">load_raster</span>(<span class="st">&quot;goleag&quot;</span>, </span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>                                 <span class="at">product =</span> <span class="st">&quot;proportion-population&quot;</span>,</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>                                 <span class="at">period =</span> <span class="st">&quot;seasonal&quot;</span>)</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="co"># state boundaries, excluding hawaii</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>states <span class="ot">&lt;-</span> <span class="fu">ne_states</span>(<span class="at">iso_a2 =</span> <span class="st">&quot;US&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>  <span class="fu">filter</span>(name <span class="sc">!=</span> <span class="st">&quot;Hawaii&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">state =</span> name) <span class="sc">|&gt;</span> </span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>  <span class="co"># transform to match projection of raster data</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="fu">st_crs</span>(prop_pop_seasonal))</span></code></pre></div>
<p>Now we can use the <code>extract()</code> function from
<code>terra</code> to calculate the proportion of the population within
each state for each season. Setting <code>weights = TRUE</code> triggers
<code>extract()</code> to calculate a weighted sum to account for
partial coverage of raster cells by the region polygons. In this
example, the <code>weights</code> argument has little impact, but it can
play a more important role for smaller regions.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>state_prop_pop <span class="ot">&lt;-</span> <span class="fu">extract</span>(prop_pop_seasonal, states, </span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>                          <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">weights =</span> <span class="cn">TRUE</span>,</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>                          <span class="at">bind =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>  <span class="co"># sort in descending order or breeding proportion of population</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(breeding))</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a><span class="fu">head</span>(state_prop_pop)</span></code></pre></div>
</div>
<div id="stats-relative" class="section level2">
<h2>Proportion of North American population</h2>
<p>For broadly distributed species, such as Golden Eagle, it may be
desirable to estimate the proportion of the population relative to a
subset of the full range. For example, let’s calculate the proportion of
the North American population within each state, where we define North
America to include the United States, Canada, and Mexico. We’ll start by
creating a polygon for the boundary of North America, using this to mask
the seasonal relative abundance raster, then dividing the masked
relative abundance raster by the total relative abundance across all of
North America to generate layers showing the proportion of North
American population.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co"># seasonal relative abundance</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>abd_seasonal <span class="ot">&lt;-</span> <span class="fu">load_raster</span>(<span class="st">&quot;goleag&quot;</span>, </span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>                            <span class="at">product =</span> <span class="st">&quot;abundance&quot;</span>,</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>                            <span class="at">period =</span> <span class="st">&quot;seasonal&quot;</span>)</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="co"># load country polygon, union into a single polygon, and project</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>noram <span class="ot">&lt;-</span> <span class="fu">ne_countries</span>(<span class="at">country =</span> <span class="fu">c</span>(<span class="st">&quot;United States of America&quot;</span>, </span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>                                  <span class="st">&quot;Canada&quot;</span>, <span class="st">&quot;Mexico&quot;</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>  <span class="fu">st_union</span>() <span class="sc">|&gt;</span> </span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="fu">st_crs</span>(abd_seasonal)) <span class="sc">|&gt;</span> </span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>  <span class="co"># vect converts an sf object to terra format for mask()</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>  <span class="fu">vect</span>()</span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a><span class="co"># mask seasonal abundance</span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a>abd_seasonal_noram <span class="ot">&lt;-</span> <span class="fu">mask</span>(abd_seasonal, noram)</span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a><span class="co"># total north american relative abundance for each season</span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a>abd_noram_total <span class="ot">&lt;-</span> <span class="fu">global</span>(abd_seasonal_noram, <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a><span class="co"># proportion of north american population</span></span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a>prop_pop_noram <span class="ot">&lt;-</span> abd_seasonal_noram <span class="sc">/</span> abd_noram_total<span class="sc">$</span>sum</span></code></pre></div>
<p>Now we can calculate the proportion of population using exactly the
same method as in the previous section.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>state_prop_noram_pop <span class="ot">&lt;-</span> <span class="fu">extract</span>(prop_pop_noram, states, </span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>                                <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">weights =</span> <span class="cn">TRUE</span>,</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>                                <span class="at">bind =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span> </span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>  <span class="co"># sort in descending order or breeding proportion of population</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(breeding))</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a><span class="fu">head</span>(state_prop_noram_pop)</span></code></pre></div>
<p>Notice that the proportions are higher than those in the previous
section since we’re now estimating the proportion of the North American
population rather than the proportion of the global population. For
example, 6% of the global breeding season population occurs in Alaska,
but this corresponds to 24% of the North American breeding season
population.</p>
</div>
<div id="stats-custom" class="section level2">
<h2>Regional stats for weeks and custom time periods</h2>
<p>The eBird Status Data Products include seasonal raster layers that
are derived from the weekly rasters based on expert defined seasons.
These seasonal layers are convenient to work with, however, in some
cases you may want to estimate the proportion of the population within a
region at the weekly level or for a custom time period. For example,
let’s estimate the proportion of the North American population within
California by week and for the month of January.</p>
<p>For this example, we’ll use the lower, 27 km resolution data in the
interest of speed, since the 3 km weekly data can be quite slow to
process. We’ll start by estimating the weekly proportion of the North
American population following an approach similar to that in the
previous section.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co"># weekly relative abundance, masked to north america</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>abd_weekly_noram <span class="ot">&lt;-</span> <span class="fu">load_raster</span>(<span class="st">&quot;goleag&quot;</span>, </span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>                                <span class="at">product =</span> <span class="st">&quot;abundance&quot;</span>, </span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>                                <span class="at">resolution =</span> <span class="st">&quot;27km&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>  <span class="fu">mask</span>(noram)</span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a><span class="co"># total north american relative abundance for each week</span></span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>abd_weekly_total <span class="ot">&lt;-</span> <span class="fu">global</span>(abd_weekly_noram, <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a><span class="co"># proportion of north american population</span></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a>prop_pop_weekly_noram <span class="ot">&lt;-</span> abd_weekly_noram <span class="sc">/</span> abd_weekly_total<span class="sc">$</span>sum</span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a><span class="co"># proportion of weekly population in california</span></span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a>california <span class="ot">&lt;-</span> <span class="fu">filter</span>(states, state <span class="sc">==</span> <span class="st">&quot;California&quot;</span>)</span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a>cali_prop_noram_pop <span class="ot">&lt;-</span> <span class="fu">extract</span>(prop_pop_weekly_noram, california, </span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a>                               <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, </span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a>                               <span class="at">weights =</span> <span class="cn">TRUE</span>, <span class="at">ID =</span> <span class="cn">FALSE</span>)</span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a>prop_pop_weekly_noram <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a>  <span class="at">week =</span> <span class="fu">as.Date</span>(<span class="fu">names</span>(cali_prop_noram_pop)),</span>
<span id="cb19-20"><a href="#cb19-20" tabindex="-1"></a>  <span class="at">prop_pop =</span> <span class="fu">as.numeric</span>(cali_prop_noram_pop[<span class="dv">1</span>, ]))</span>
<span id="cb19-21"><a href="#cb19-21" tabindex="-1"></a><span class="fu">head</span>(prop_pop_weekly_noram)</span></code></pre></div>
<p>This data frame gives the weekly proportion of the North American
population of Golden Eagle in California; the structure is very similar
to the data we generated in the <a href="#chron">migration
chronology</a> section. We can take this one step further and average
the proportion of population across the weeks in the month of
January.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>prop_pop_weekly_noram <span class="sc">|&gt;</span> </span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">month</span>(week) <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">prop_pop =</span> <span class="fu">mean</span>(prop_pop))</span></code></pre></div>
</div>
<div id="stats-coastal" class="section level2">
<h2>Coastal species</h2>
<p>There is one particular case where the methods we have presented so
far for regional statistics can cause issues: species with a significant
proportion of their population in offshore or tidal areas. Many regional
polygons, including those from Natural Earth used so far, only capture
the land area, resulting in a large proportion of non-zero relative
abundance cells falling outside the polygons. For example, let’s
estimate the proportion of the global non-breeding season population of
<a href="https://ebird.org/species/sursco">Surf Scoter</a> in Mexico
using the naive approach used in the previous examples.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co"># download only the season proportion of population layer</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="fu">ebirdst_download_status</span>(<span class="st">&quot;Surf Scoter&quot;</span>, </span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>                        <span class="at">pattern =</span> <span class="st">&quot;proportion-population_seasonal_mean_3km&quot;</span>)</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a><span class="co"># breeding season proportion of population</span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a>abd_nonbreeding <span class="ot">&lt;-</span> <span class="fu">load_raster</span>(<span class="st">&quot;Surf Scoter&quot;</span>,</span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>                               <span class="at">product =</span> <span class="st">&quot;proportion-population&quot;</span>,</span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>                               <span class="at">period =</span> <span class="st">&quot;seasonal&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a>  <span class="fu">subset</span>(<span class="st">&quot;nonbreeding&quot;</span>)</span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a><span class="co"># load a polygon for the boundary of Mexico</span></span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a>mexico <span class="ot">&lt;-</span> <span class="fu">ne_countries</span>(<span class="at">country =</span> <span class="st">&quot;Mexico&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="fu">st_crs</span>(abd_nonbreeding))</span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a><span class="co"># proportion in mexico</span></span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a><span class="fu">extract</span>(abd_nonbreeding, mexico, <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">ID =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>According to this method, about 20% of the non-breeding population of
Surf Scoter occurs in Mexico. However, Surf Scoter is an exclusively
coastal species and this naive estimate is missing a large part of the
population because the coarse boundary for Mexico we’re using doesn’t
capture many of the 3 km raster cells that are falling offshore. We can
correct for this by buffering the Mexico polygon by 5 km to try to
capture these coastal cells. We’ll also use <code>touches = TRUE</code>
to include raster cells that are touched by the Mexico polygon; without
that argument, only cells whose centers fall within the Mexico polygon
will be included.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="co"># buffer by 5000m = 5km</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>mexico_buffer <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(mexico, <span class="at">dist =</span> <span class="dv">5000</span>)</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a><span class="co"># proportion in mexico</span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a><span class="fu">extract</span>(abd_nonbreeding, mexico_buffer, <span class="at">fun =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>,</span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>        <span class="at">touches =</span> <span class="cn">TRUE</span>, <span class="at">ID =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>With these adjustments the proportion of the population has increased
substantially from 20% to 33%. These approaches are not perfect and care
should always be taken when working with eBird Status and Trends Data
Products for coastal species.</p>
</div>
</div>
<div id="aoi" class="section level1">
<h1>Areas of importance</h1>
<blockquote>
<p><strong>Goal:</strong> identify areas of highest importance for a set
of species within a region. This information can be used to identify
areas to prioritize for protection or other conservation
interventions.</p>
</blockquote>
<p>eBird Status Data Products can used to identify areas of importance
for a species or group of species, which can help prioritize areas for
protection or other conservation interventions. In this context, “areas
of importance” refer to those areas within the landscape that have a
higher concentration of the given species. For this application, we’ll
use the same set of grassland species in Montana during the breeding
season as we used for the migration chronology example.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co"># species list</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>grassland_species <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Baird&#39;s Sparrow&quot;</span>,</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>                       <span class="st">&quot;Bobolink&quot;</span>,</span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>                       <span class="st">&quot;Chestnut-collared Longspur&quot;</span>,</span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>                       <span class="st">&quot;Sprague&#39;s Pipit&quot;</span>,</span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>                       <span class="st">&quot;Upland Sandpiper&quot;</span>,</span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>                       <span class="st">&quot;Western Meadowlark&quot;</span>)</span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a><span class="co"># region boundary</span></span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a>region_boundary <span class="ot">&lt;-</span> <span class="fu">ne_states</span>(<span class="at">iso_a2 =</span> <span class="st">&quot;US&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a>  <span class="fu">filter</span>(name <span class="sc">==</span> <span class="st">&quot;Montana&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb23-12"><a href="#cb23-12" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="fu">st_crs</span>(abd_breeding)) <span class="sc">|&gt;</span> </span>
<span id="cb23-13"><a href="#cb23-13" tabindex="-1"></a>  <span class="fu">vect</span>()</span></code></pre></div>
<div id="aoi-richness" class="section level2">
<h2>Richness</h2>
<p>The simplest approach to identifying important areas is to generate a
richness map showing the number of species falling within each 3 km grid
cell. We’ll start by converting the relative abundance rasters to binary
presence-absence rasters for each species within the region of interest
by converting any non-zero abundance values to one. Then we calculate a
cell-wise sum across the binary rasters for each species to generate a
richness raster.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>range_rasters <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a><span class="cf">for</span> (species <span class="cf">in</span> grassland_species) {</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>  <span class="co"># download seasonal abundance at 3km</span></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>  <span class="fu">ebirdst_download_status</span>(species, <span class="at">pattern =</span> <span class="st">&quot;abundance_seasonal_mean_3km&quot;</span>)</span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>  <span class="co"># load breeding season relative abundance</span></span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a>  abd <span class="ot">&lt;-</span> <span class="fu">load_raster</span>(species, <span class="at">period =</span> <span class="st">&quot;seasonal&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a>    <span class="fu">subset</span>(<span class="st">&quot;breeding&quot;</span>)</span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a>  <span class="co"># crop and mask to region</span></span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a>  abd_masked <span class="ot">&lt;-</span> <span class="fu">mask</span>(<span class="fu">crop</span>(abd, region_boundary), region_boundary)</span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a>  <span class="co"># convert to binary, presence-absence</span></span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a>  range_rasters[[species]] <span class="ot">&lt;-</span> abd_masked <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a>}</span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a><span class="co"># sum across species to calculate richness</span></span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a>richness <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">rast</span>(range_rasters), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p>Then we can make a simple map that shows the number of species (out
of six total) that occur within each 3 km grid cell.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co"># make a simple map</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="fu">plot</span>(richness, <span class="at">axes =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
<div id="aoi-importance" class="section level2">
<h2>Importance</h2>
<p>The richness map generated in the previous section is intuitive and
gives a general sense of where grassland species are occurring within
Montana. However, presence-absence is a coarse metric: species may occur
at dramatically different densities from location to location and, in
general, it’s most strategic to invest conservation resources in areas
with higher concentrations of the target species. We can take full
advantage of the relative abundance estimates to generate an importance
metric that is much more granular than richness.</p>
<p>Recall that when combining estimates across species it’s important to
use proportion of population rather than relative abundance to account
for differences in the detection process. So, we’ll load the
pre-generated proportion of population rasters for each species, then
average them across species to produce a metric of importance.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>prop_pop <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="cf">for</span> (species <span class="cf">in</span> grassland_species) {</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>  <span class="co"># download seasonal abundance at 3km</span></span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>  <span class="fu">ebirdst_download_status</span>(species,</span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a>                          <span class="at">pattern =</span> <span class="st">&quot;proportion-population_seasonal_mean_3km&quot;</span>)</span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a>  <span class="co"># load breeding season proportion of population</span></span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a>  pp <span class="ot">&lt;-</span> <span class="fu">load_raster</span>(species,</span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a>                    <span class="at">product =</span> <span class="st">&quot;proportion-population&quot;</span>,</span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a>                    <span class="at">period =</span> <span class="st">&quot;seasonal&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a>    <span class="fu">subset</span>(<span class="st">&quot;breeding&quot;</span>)</span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a>  <span class="co"># crop and mask to region</span></span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a>  prop_pop[[species]] <span class="ot">&lt;-</span> <span class="fu">mask</span>(<span class="fu">crop</span>(pp, region_boundary), region_boundary)</span>
<span id="cb26-14"><a href="#cb26-14" tabindex="-1"></a>}</span>
<span id="cb26-15"><a href="#cb26-15" tabindex="-1"></a><span class="co"># take mean across species</span></span>
<span id="cb26-16"><a href="#cb26-16" tabindex="-1"></a>importance <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">rast</span>(prop_pop), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p>Now let’s make a simple map of this importance metric.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="fu">plot</span>(importance, <span class="at">axes =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>This metric ranges from 0-1 and expresses the mean proportion of the
population across the six grassland species within each cell. The raw
numeric values are hard to interpret and not particularly meaningful,
what’s most important is the relative ranking of cells. We can make the
map more useful by removing the zeros as well as small values. We’ll
drop all cell values below the median, but depending on your application
you may want to chose a different value.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="co"># drop zeros</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>importance <span class="ot">&lt;-</span> <span class="fu">ifel</span>(importance <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA</span>, importance)</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a><span class="co"># drop anything below the median</span></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a>cutoff <span class="ot">&lt;-</span> <span class="fu">global</span>(importance, quantile, <span class="at">probs =</span> <span class="fl">0.5</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a>  <span class="fu">as.numeric</span>()</span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>importance <span class="ot">&lt;-</span> <span class="fu">ifel</span>(importance <span class="sc">&gt;</span> cutoff, importance, <span class="cn">NA</span>)</span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a><span class="co"># make a simple map</span></span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a><span class="fu">plot</span>(importance, <span class="at">axes =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a><span class="fu">plot</span>(region_boundary, <span class="at">col =</span> <span class="st">&quot;grey&quot;</span>, <span class="at">axes =</span> <span class="cn">FALSE</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a><span class="fu">plot</span>(importance, <span class="at">axes =</span> <span class="cn">FALSE</span>, <span class="at">legend =</span> <span class="cn">FALSE</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p>This map does a better job of highlighting the most important areas
for grassland birds within Montana. Let’s go one step further and add a
better legend and re-project the data using the same region-specific
coordinate reference system as we used in the <a href="#map-projection">mapping example in this vignette</a>.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="co"># reproject</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>importance_proj <span class="ot">&lt;-</span> <span class="fu">trim</span>(<span class="fu">project</span>(importance, crs_laea))</span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a>region_boundary_proj <span class="ot">&lt;-</span> <span class="fu">project</span>(region_boundary, crs_laea)</span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a><span class="co"># basemap</span></span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a><span class="fu">plot</span>(region_boundary_proj, <span class="at">col =</span> <span class="st">&quot;grey&quot;</span>, <span class="at">axes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">&quot;Areas of importance for grassland birds in Montana&quot;</span>)</span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a><span class="co"># add importance raster</span></span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a><span class="fu">plot</span>(importance_proj, <span class="at">legend =</span> <span class="cn">FALSE</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a><span class="co"># add legend</span></span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a>fields<span class="sc">::</span><span class="fu">image.plot</span>(<span class="at">zlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">legend.only =</span> <span class="cn">TRUE</span>,</span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a>                   <span class="at">col =</span> viridisLite<span class="sc">::</span><span class="fu">viridis</span>(<span class="dv">100</span>),</span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a>                   <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">101</span>),</span>
<span id="cb29-14"><a href="#cb29-14" tabindex="-1"></a>                   <span class="at">smallplot =</span> <span class="fu">c</span>(<span class="fl">0.15</span>, <span class="fl">0.85</span>, <span class="fl">0.12</span>, <span class="fl">0.15</span>),</span>
<span id="cb29-15"><a href="#cb29-15" tabindex="-1"></a>                   <span class="at">horizontal =</span> <span class="cn">TRUE</span>,</span>
<span id="cb29-16"><a href="#cb29-16" tabindex="-1"></a>                   <span class="at">axis.args =</span> <span class="fu">list</span>(<span class="at">at =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>),</span>
<span id="cb29-17"><a href="#cb29-17" tabindex="-1"></a>                                    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Low&quot;</span>, <span class="st">&quot;Medium&quot;</span>, <span class="st">&quot;High&quot;</span>),</span>
<span id="cb29-18"><a href="#cb29-18" tabindex="-1"></a>                                    <span class="at">fg =</span> <span class="st">&quot;black&quot;</span>, <span class="at">col.axis =</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb29-19"><a href="#cb29-19" tabindex="-1"></a>                                    <span class="at">cex.axis =</span> <span class="fl">0.75</span>, <span class="at">lwd.ticks =</span> <span class="fl">0.5</span>,</span>
<span id="cb29-20"><a href="#cb29-20" tabindex="-1"></a>                                    <span class="at">padj =</span> <span class="sc">-</span><span class="fl">1.5</span>),</span>
<span id="cb29-21"><a href="#cb29-21" tabindex="-1"></a>                   <span class="at">legend.args =</span> <span class="fu">list</span>(<span class="at">text =</span> <span class="st">&quot;Relative Importance&quot;</span>,</span>
<span id="cb29-22"><a href="#cb29-22" tabindex="-1"></a>                                      <span class="at">side =</span> <span class="dv">3</span>, <span class="at">col =</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb29-23"><a href="#cb29-23" tabindex="-1"></a>                                      <span class="at">cex =</span> <span class="dv">1</span>, <span class="at">line =</span> <span class="dv">0</span>))</span></code></pre></div>
<p>We’ve presented one simple example of identifying priority areas for
birds using the eBird Status Data Products; however, this method is
quite flexible and can be tailored to your particular use case. At the
very least, the focal region, season, and species should be modified for
your application. In some cases, species may be present in your focal
region throughout the full annual cycle and you may want to consider an
importance metric derived by combing multiple seasons of data for each
species or using weekly estimates to identify the week of highest
importance for each species.</p>
<p>For a more robust approach to this this problem, you may want to use
eBird Status Data Products within the framework of Systematic
Conservation Prioritization. Tools such as the R package <a href="https://prioritizr.net/"><code>prioritizr</code></a> can be used
in conjunction with the eBird Status Data Products to solve spatial
conservation planning problems with a broad range of objectives and
constraints.</p>
</div>
</div>
<div id="ppms" class="section level1">
<h1>Assessing model performance</h1>
<blockquote>
<p><strong>Goal:</strong> use the spatial predictive performance metrics
(PPMs) to assess how model performance varies across the range of a
species.</p>
</blockquote>
<p>eBird Status and Trends species species are assigned <a href="https://ebird.github.io/ebirdst/articles/status.html#species">quality
scores (0-3)</a> for each season describing the quality of the model
predictions across the full range of the species. For example, let’s
look at the breeding season quality for Horned Lark.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a>horlar_review <span class="ot">&lt;-</span> <span class="fu">filter</span>(ebirdst_runs, species_code <span class="sc">==</span> <span class="st">&quot;horlar&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>  <span class="fu">select</span>(breeding_quality, breeding_start, breeding_end)</span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a><span class="fu">print</span>(horlar_review)</span></code></pre></div>
<p>This score (2) corresponds to “medium quality”, indicating there is
some extrapolation or omission in the breeding season predictions.
However, Horned Lark is a <a href="https://science.ebird.org/en/status-and-trends/species/horlar/abundance-map?season=breeding">broadly
distributed species</a>, occurring throughout the <a href="https://en.wikipedia.org/wiki/Holarctic_realm">holarctic
realm</a>. Data users are typically interested in model predictions
within a particular region, but the quality score gives no indication of
where the extrapolation or omission is occurring, only that it occurs
somewhere within the range. Someone working with predictions from the
Mongolian portion of the range may be dealing with very different
prediction quality than someone working with predictions from the part
of the range in the Western United States.</p>
<p>While the model quality scores are quite coarse, the spatial
predictive performance metrics (PPMs) available for each species provide
much finer scale information on model quality. For migratory species
like Horned Lark, these data products provide suite of performance
metrics at weekly 27 km resolution. These PPMs are not downloaded by
default by <code>ebirdst_download_status()</code>, but you can download
them with <code>download_ppms = TRUE</code>. Let’s download the PPMs and
load the proportion of the Bernoulli deviance explained metric, which is
typically one of the most useful for assessing model quality.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="co"># download and load ppm</span></span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a><span class="fu">ebirdst_download_status</span>(<span class="st">&quot;horlar&quot;</span>, <span class="at">download_ppms =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a>bernoulli_dev <span class="ot">&lt;-</span> <span class="fu">load_ppm</span>(<span class="st">&quot;horlar&quot;</span>, <span class="at">ppm =</span> <span class="st">&quot;occ_bernoulli_dev&quot;</span>)</span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a><span class="fu">print</span>(bernoulli_dev)</span></code></pre></div>
<p>The data are in the form of a 27 km raster with 52 layers, one for
each week of the year. Let’s average these PPMs across the weeks in the
breeding season, subset to just the portion of the range within the
United States and Canada, and make a map.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="co"># subset to weeks in breeding season and average</span></span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a>breeding_dates <span class="ot">&lt;-</span> <span class="fu">c</span>(horlar_review<span class="sc">$</span>breeding_start, horlar_review<span class="sc">$</span>breeding_end) <span class="sc">|&gt;</span> </span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a>  <span class="fu">format</span>(<span class="st">&quot;%m-%d&quot;</span>)</span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a>in_breeding <span class="ot">&lt;-</span> <span class="fu">names</span>(bernoulli_dev) <span class="sc">&gt;=</span> breeding_dates[<span class="dv">1</span>] <span class="sc">&amp;</span> </span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a>  <span class="fu">names</span>(bernoulli_dev) <span class="sc">&lt;=</span> breeding_dates[<span class="dv">2</span>]</span>
<span id="cb32-6"><a href="#cb32-6" tabindex="-1"></a>bernoulli_dev_breeding <span class="ot">&lt;-</span> <span class="fu">mean</span>(bernoulli_dev[[in_breeding]], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-7"><a href="#cb32-7" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" tabindex="-1"></a><span class="co"># mask to just canada and the united states</span></span>
<span id="cb32-9"><a href="#cb32-9" tabindex="-1"></a>us_ca <span class="ot">&lt;-</span> <span class="fu">ne_countries</span>(<span class="at">country =</span> <span class="fu">c</span>(<span class="st">&quot;United States of America&quot;</span>, <span class="st">&quot;Canada&quot;</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb32-10"><a href="#cb32-10" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="fu">st_crs</span>(bernoulli_dev_breeding))</span>
<span id="cb32-11"><a href="#cb32-11" tabindex="-1"></a>bernoulli_dev_breeding_us_ca <span class="ot">&lt;-</span> bernoulli_dev_breeding <span class="sc">|&gt;</span> </span>
<span id="cb32-12"><a href="#cb32-12" tabindex="-1"></a>  <span class="fu">crop</span>(us_ca) <span class="sc">|&gt;</span> </span>
<span id="cb32-13"><a href="#cb32-13" tabindex="-1"></a>  <span class="fu">mask</span>(us_ca) <span class="sc">|&gt;</span> </span>
<span id="cb32-14"><a href="#cb32-14" tabindex="-1"></a>  <span class="fu">trim</span>()</span>
<span id="cb32-15"><a href="#cb32-15" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" tabindex="-1"></a><span class="co"># make a map</span></span>
<span id="cb32-17"><a href="#cb32-17" tabindex="-1"></a>ppm_cols <span class="ot">&lt;-</span> <span class="fu">rev</span>(<span class="fu">scico</span>(<span class="dv">100</span>, <span class="at">palette =</span> <span class="st">&quot;vik&quot;</span>))</span>
<span id="cb32-18"><a href="#cb32-18" tabindex="-1"></a>max_val <span class="ot">&lt;-</span> <span class="fu">global</span>(<span class="fu">abs</span>(bernoulli_dev_breeding_us_ca), <span class="at">fun =</span> max, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb32-19"><a href="#cb32-19" tabindex="-1"></a>  <span class="fu">as.numeric</span>()</span>
<span id="cb32-20"><a href="#cb32-20" tabindex="-1"></a><span class="fu">plot</span>(bernoulli_dev_breeding_us_ca, </span>
<span id="cb32-21"><a href="#cb32-21" tabindex="-1"></a>     <span class="at">range =</span> <span class="fu">c</span>(<span class="sc">-</span>max_val, max_val),</span>
<span id="cb32-22"><a href="#cb32-22" tabindex="-1"></a>     <span class="at">col =</span> ppm_cols,</span>
<span id="cb32-23"><a href="#cb32-23" tabindex="-1"></a>     <span class="at">axes =</span> <span class="cn">FALSE</span>, <span class="at">box =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-24"><a href="#cb32-24" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(us_ca), <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p>Negative proportions of the deviance explained (red in the above map)
indicate that the occurrence model is performing worse than a NULL model
and extra caution should be used when using predictions from these
areas.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
